<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Driver App</title>
<!-- Leaflet CSS (if needed for maps or other features) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  /* Basic styling for the app */

  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f4f4;
  }

  /* Header styles: contains Driver label and menu button */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    position: relative;
  }

  /* Driver label styling */
  .driver-label {
    font-weight: bold;
    color: red;
    font-size: 20px;
  }

  /* Menu container and button styles */
  .menu-container {
    position: relative;
  }

  .menu-button {
    background-color: red;
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
  }

  /* Hover effect for menu button */
  .menu-button:hover {
    background-color: darkred;
  }

  /* Dropdown menu styles */
  .dropdown-content {
    display: none; /* Hidden by default, toggled via JS */
    position: absolute;
    right: 0;
    top: 100%;
    background-color: #fff;
    min-width: 200px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    border-radius: 4px;
    overflow: hidden;
  }

  /* Links inside dropdown menu */
  .dropdown-content a {
    display: block;
    padding: 10px 15px;
    text-decoration: none;
    color: #333;
    border-bottom: 1px solid #ddd;
  }

  /* Highlight on hover */
  .dropdown-content a:hover {
    background-color: #f2f2f2;
  }

  /* Show dropdown when active */
  .menu-container.show .dropdown-content {
    display: block;
  }

  /* Main content container, hidden initially */
  #contentArea {
    display: none; /* will be shown after page load */
    max-width: 900px;
    margin: 20px auto;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  /* Style for the 'Forgot Password' link to appear centered and look like a link */
  #loginForgotPassword {
    display: block;
    text-align: center;
    margin: 10px auto;
    cursor: pointer;
    color: blue;
    text-decoration: underline;
    font-size: 14px;
  }
</style>
</head>
<body>

<!-- Main content area that is shown after page load -->
<div id="contentArea">
  <!-- Header section: displays Driver label and Menu button -->
  <div class="header" id="mainHeader">
    <div class="driver-label">Driver</div>
    <!-- Menu container with toggle button and dropdown links -->
    <div class="menu-container" id="menuContainer">
      <button class="menu-button" id="menuButton">Menu ▼</button>
      <div class="dropdown-content" id="dropdownContent">
        <!-- Navigation links in dropdown -->
        <a href="#" id="orderViewLink">Order View</a>
        <a href="#" id="driverAccountLink">Driver View Account</a>
        <a href="#" id="driverHistoryPayment">Driver History Payment</a>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </div>
  </div>

  <!-- Dynamic content will be injected here -->
  <div id="innerContent"></div>
</div>


<div id="notification" style="display:none; position:fixed; top:20px; width:100%; z-index:9999; text-align:center;">
  <div style="background-color:#4CAF50; color:white; padding:10px; display:inline-block; border-radius:4px;">
    Sending notification...
  </div>
</div>
<!-- Notification page / section (script will handle content) -->
<script type="text/babel" src="./src/index.jsx"></script>

<!-- Google Maps API (replace 'YOUR_API_KEY' with your actual key) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9sNhi824hNncjfW7HHzaI_s8JtWGfM0Q"></script>

<script>
function showNotificationMessage(message, color='#4CAF50') {
  const notif = document.getElementById('notification');
  notif.innerHTML = `<div style="background-color:${color}; color:#fff; padding:10px; display:inline-block; border-radius:4px;">${message}</div>`;
  notif.style.display = 'block';

  // Hide after 3 seconds
  setTimeout(() => {
    notif.style.display = 'none';
  }, 3000);
}
//


let isSendingSMS = false;

function sendTwilioNotification(to, message) {
  if (!to || !message) {
    showNotificationMessage('Missing phone number or message', '#f44336');
    return;
  }

  if (isSendingSMS) {
    showNotificationMessage('Message already sending...', '#ff9800');
    return;
  }

  isSendingSMS = true;

  showNotificationMessage('Sending message...', '#2196F3');

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout

  fetch('/api/sms', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    signal: controller.signal,
    body: JSON.stringify({ to, message })
  })
  .then(async res => {
    clearTimeout(timeout);
    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || 'Server error');
    }

    if (data.success === true || data.sid) {
      showNotificationMessage('Message sent successfully ✔️', '#4CAF50');
      if (typeof playNotificationSound === 'function') {
        playNotificationSound();
      }
    } else {
      throw new Error('Twilio rejected the message');
    }
  })
  .catch(err => {
    if (err.name === 'AbortError') {
      showNotificationMessage('Request timed out ⏱️', '#f44336');
    } else {
      showNotificationMessage(`Failed to send message ❌`, '#f44336');
    }
    console.error('SMS Error:', err);
  })
  .finally(() => {
    isSendingSMS = false;
  });
}




function showNotificationMessage(text, color = '#333') {
  const container = document.getElementById('notificationContainer');
  if (!container) return;

  container.innerHTML = `
    <div style="
      padding:10px;
      background:${color};
      color:#fff;
      border-radius:8px;
      font-size:14px;
    ">
      ${text}
    </div>
  `;
}

function playNotificationSound() {
  const audio = new Audio('/sounds/notify.mp3'); // optional
  audio.play().catch(() => {});
}



function sendSms(to, message) {
  sendTwilioNotification(to, message);
}


  // Function to load notification page content
function loadNotificationPage() {
  document.getElementById('innerContent').innerHTML = `
    <h1>Notifications</h1>
    <div id="notificationContainer" style="border:1px solid #ccc; padding:10px; border-radius:5px; min-height:100px;">
      <p>No new notifications.</p>
    </div>
    <button id="simulateNotification">Simulate Notification</button>
    <a href="#" id="backToMain">Back</a>
  `;
  document.getElementById('backToMain').onclick = (e) => {
    e.preventDefault();
    loadMainPage();
  };
  document.getElementById('simulateNotification').onclick = () => {
    showNotification("This is a test notification!", "notification.mp3");
  };
}

// Initialize menu and main content after DOM loads
document.addEventListener('DOMContentLoaded', () => {
  // Show main content container
  document.getElementById('contentArea').style.display = 'block';

  // Initialize menu toggle and links
  initializeMenu();

  function initializeMenu() {
    const menuBtn = document.getElementById('menuButton');
    const dropdown = document.getElementById('dropdownContent');

    // Toggle dropdown menu on button click
    menuBtn.addEventListener('click', () => {
      dropdown.parentElement.classList.toggle('show');
    });
    // Close menu if clicking outside
    document.addEventListener('click', (e) => {
      if (!dropdown.parentElement.contains(e.target)) {
        dropdown.parentElement.classList.remove('show');
      }
    });

    // Assign functions to menu links
    document.getElementById('orderViewLink').onclick = () => { loadOrderView(); };
    document.getElementById('driverAccountLink').onclick = () => { loadDriverAccount(); };
    document.getElementById('driverHistoryPayment').onclick = () => { loadDriverHistoryPayment(); };
    document.getElementById('logoutLink').onclick = () => {
      localStorage.removeItem('driverEmail');
      localStorage.removeItem('driverPassword');
      alert('Logged out.');
      location.reload();
    };
  }

  // Function to load Order View content
function loadOrderView() {
  document.getElementById('innerContent').innerHTML = `
    <h1>Order Details</h1>
    <div class="order-details">
      <p><strong>Order ID:</strong> #12345</p>
      <p><strong>Customer Name:</strong> John Doe</p>
      <p><strong>Order Date:</strong> August 15, 2025</p>
      <p><strong>Status:</strong> Processing</p>
      <p><strong>Order within your area:</strong> Yes (simulated GPS location)</p>
      <p><strong>Order Address:</strong> 123 Main St, Cape Town</p>
      <p><strong>Total Amount:</strong> R99.99</p>
    </div>
    <div class="order-items">
      <h2>Order Items</h2>
      <table>
        <thead>
          <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>
        </thead>
        <tbody>
          <tr><td>Product A</td><td>2</td><td>R29.99</td><td>R59.98</td></tr>
          <tr><td>Product B</td><td>1</td><td>R40.01</td><td>R40.01</td></tr>
        </tbody>
      </table>
    </div>
    <a href="#" id="backToMain">Back</a>
  `;
  document.getElementById('backToMain').onclick = (e) => {
    e.preventDefault();
    loadMainPage();
  };
}

// Function to load Driver Account details
function loadDriverAccount() {
  const driver = JSON.parse(localStorage.getItem('driverData')) || {};

  document.getElementById('innerContent').innerHTML = `
    <h1>Driver Profile</h1>
    <form id="driverProfileForm">
      <label>Name:</label>
      <input type="text" id="profileName" value="${driver.name || ''}" />
      <label>Email:</label>
      <input type="email" id="profileEmail" value="${driver.email || ''}" />
      <label>ID Number:</label>
      <input type="text" id="profileID" value="${driver.idNumber || ''}" />
      <label>Bank Details:</label>
      <input type="text" id="profileBankDetails" value="${driver.bankDetails || ''}" />
      <label>Bank Name:</label>
      <select id="profileBankName">
        <option value="FNB" ${driver.bankName==='FNB'?'selected':''}>FNB</option>
        <option value="Standard Bank" ${driver.bankName==='Standard Bank'?'selected':''}>Standard Bank</option>
        <option value="Capitec" ${driver.bankName==='Capitec'?'selected':''}>Capitec</option>
        <option value="NedBank" ${driver.bankName==='NedBank'?'selected':''}>NedBank</option>
        <option value="Other" ${driver.bankName==='Other'?'selected':''}>Other</option>
      </select>
      <div id="editOtherBankDiv" style="display:${driver.bankName==='Other'?'block':'none'};">
        <label>Specify Bank:</label>
        <input type="text" id="editOtherBank" value="${driver.otherBank || ''}" />
      </div>
      <label>Driver License:</label>
      <input type="file" accept="image/*" id="profileLicense" />
      <label>Car Color:</label>
      <input type="text" id="profileCarColor" value="${driver.carColor || ''}" />
      <label>Car Type:</label>
      <input type="text" id="profileCarType" value="${driver.carType || ''}" />
      <label>Car Photo:</label>
      <input type="file" accept="image/*" id="profileCarPhoto" />
      <label>Car Registration Number:</label>
      <input type="text" id="profileCarReg" value="${driver.carRegNumber || ''}" />
      <button type="submit" class="action-btn">Save</button>
    </form>
    <button id="terminateBtn" style="margin-top:10px; background-color:red;">Terminate Driver</button>
    <a href="#" id="backToMain">Back</a>
  `;
  document.getElementById('profileBankName').onchange = () => {
    document.getElementById('editOtherBankDiv').style.display = (document.getElementById('profileBankName').value==='Other')?'block':'none';
  };
  setTimeout(() => {
    document.getElementById('driverProfileForm').onsubmit = (e) => {
      e.preventDefault();
      const updatedDriver = {
        name: document.getElementById('profileName').value,
        email: document.getElementById('profileEmail').value,
        idNumber: document.getElementById('profileID').value,
        bankDetails: document.getElementById('profileBankDetails').value,
        bankName: document.getElementById('profileBankName').value,
        carColor: document.getElementById('profileCarColor').value,
        carType: document.getElementById('profileCarType').value,
        carRegNumber: document.getElementById('profileCarReg').value,
      };
      alert('Profile saved and sent to admin.');
      localStorage.setItem('driverData', JSON.stringify(updatedDriver));
    };
    document.getElementById('terminateBtn').onclick = () => {
      if (confirm('Are you sure you want to terminate your driver account? Admin will be notified.')) {
        alert('Termination request sent to admin.');
        localStorage.removeItem('driverData');
        loadMainPage();
      }
    };
    document.getElementById('backToMain').onclick = (e) => {
      e.preventDefault();
      loadMainPage();
    };
  }, 100);
}

// Load Driver Payment History
function loadDriverHistoryPayment() {
  fetch('/api/payment-history')
    .then(res => res.json())
    .then(data => {
      let historyHtml = `<h1>Payment History</h1>`;

      let totalOutstanding = 0;

      if (data?.payments?.length) {
        data.payments.forEach(payment => {
          totalOutstanding += Number(payment.amount);

          historyHtml += `
            <div class="history-payment" style="border:1px solid #ccc;padding:10px;margin-bottom:10px;border-radius:8px;">
              <p><strong>Amount:</strong> R ${payment.amount}</p>
              <p><strong>User:</strong> ${payment.userName}</p>
              <p><strong>Date:</strong> ${payment.date}</p>
              <p><strong>Pick-up:</strong> ${payment.pickupLocation}</p>
              <p><strong>Drop-off:</strong> ${payment.dropoffLocation}</p>
            </div>`;
        });
      } else {
        historyHtml += `<p>No payment history found.</p>`;
      }

      historyHtml += `
        <h3>Total Due: R ${totalOutstanding.toFixed(2)}</h3>

        <div style="margin-top:15px">
          <label><input type="radio" name="paymethod" value="cc" checked> Card</label>
          <label style="margin-left:15px"><input type="radio" name="paymethod" value="eft"> Instant EFT</label>
        </div>

        <button id="payFastButton" style="margin-top:15px;padding:12px;background:#28a745;color:#fff;border:none;border-radius:6px;">
          Pay with PayFast
        </button>

        <form id="payFastForm" method="POST" action="https://sandbox.payfast.co.za/eng/process">
          <input type="hidden" name="merchant_id" value="10000100">
          <input type="hidden" name="merchant_key" value="46f0cd694581a">

          <input type="hidden" name="return_url" value="http://127.0.0.1:5501/success.html">
          <input type="hidden" name="cancel_url" value="http://127.0.0.1:5501/dashboard.html">
          <input type="hidden" name="notify_url" value="http://127.0.0.1:5501/payfast_notify.php">

          <input type="hidden" name="m_payment_id" id="pfOrderId">
          <input type="hidden" name="item_name" value="Driver Payout">
          <input type="hidden" name="amount" id="pfAmount">
          <input type="hidden" name="payment_method" id="pfMethod">
        </form>
      `;

      document.getElementById('innerContent').innerHTML = historyHtml;

      // Set PayFast values
      document.getElementById("pfAmount").value = totalOutstanding.toFixed(2);
      document.getElementById("pfOrderId").value = "DRIVER_" + Date.now();

      document.getElementById("payFastButton").onclick = () => {
        const method = document.querySelector("input[name='paymethod']:checked").value;
        document.getElementById("pfMethod").value = method;
        document.getElementById("payFastForm").submit();
      };

      // Back button
      const back = document.createElement("a");
      back.innerText = "Back";
      back.href = "#";
      back.style.display = "block";
      back.style.marginTop = "20px";
      back.onclick = e => {
        e.preventDefault();
        loadMainPage();
      };
      document.getElementById("innerContent").appendChild(back);
    })
    .catch(err => {
      console.error(err);
      document.getElementById("innerContent").innerHTML = `
        <h1>Payment History</h1>
        <p>Error loading data.</p>
        <a href="#" id="backToMain">Back</a>
      `;
      document.getElementById("backToMain").onclick = e => {
        e.preventDefault();
        loadMainPage();
      };
    });
}



// Function to show main page
function loadMainPage() {
  document.getElementById('contentArea').style.display = 'block';
  document.getElementById('mainHeader').style.display = 'flex';
  initializeMenu();
}

}); // End of DOMContentLoaded
 async function updatePayment(paymentData) {
  try {
    showNotificationMessage('Updating payment...', '#2196F3');

    const res = await fetch('/api/updatePayment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(paymentData)
    });

    const result = await res.json();

    if (!res.ok) {
      throw new Error(result.error || 'Payment update failed');
    }

    showNotificationMessage('Payment updated successfully ✔️', '#4CAF50');
    playNotificationSound();

    return result;
  } catch (err) {
    console.error('Error updating payment:', err);
    showNotificationMessage('Error updating payment ❌', '#f44336');
    throw err;
  }
}



</script>
<script src="client/public/functions/driver_map.js"async></script>

<script src="smsAndEmailAPI.js"async></script>

 
<script src="client/public/functions/driver_tracking_connection.js" async></script> 
 <script  src="client/public/functions/driverTracker.js" async></script>
<script  src="client/public/functions/mainTwilioFunction.js" async></script>
<script src="client/public/functions/map.js" async></script>
<script src="client/public/functions/payfast.js" async></script>
<script src="client/public/functions/PayfastCheckout.js" async></script>
<script src="client/public/functions/pinpoint.js" async></script>
<script src="client/public/functions/sendSMS.js" async></script>
<script src="client/public/functions/token.js" async></script>
<script  src="client/public/functions/twilio_serverless_function.js" async></script>
<script  src="client/public/components/createPayFastPayment.js" async></script>
<script  src="client/public/components/DriverPaymentHistory.js" async></script>
<script  src="client/public/components/DriverViewAccount.js" async></script>
<script   src="client/public/components/real_time_data_fetching.js" async></script>

<script  src="client/public/hooks/useAuth.js" async></script>
<script  src="client/public/hooks/useDebounce.js" async></script>
<script  src="client/public/hooks/useFetch.js" async></script>
<script  src="client/public/hooks/LocalStorage.js" async></script>

<script  src="client/public/pages/capture_location.jsx" async></script>
<script  src="client/public/pages/CheckoutPage.js" async></script>
<script  src="client/public/pages/driver_map_change.jsx" async></script>
<script src="client/public/pages/DriverHistoryPayment.jsx" async></script>
<script  src="client/public/pages/driverlogin.jsx" async></script>
<script  src="client/public/pages/DriverMap.jsx" async></script>
<script  src="client/public/pages/DriverProfile.jsx" async></script>
<script  src="client/public/pages/DriverViewAccount.jsx" async></script>
<script  src="client/public/pages/forgotpassword.jsx" async></script>
<script  src="client/public/pages/OrderView.jsx" async></script>
<script  src="client/public/pages/registerdriver.jsx" async></script>

<script  src="server/supabase/env.local" async></script>
<script  src="server/supabase/supabaseClient.js" async></script>

<script  src="server/api.client.js" async></script>
<script  src="server/map.js" async></script>
<script  src="server/maps.client.js" async></script>
<script  src="server/notification.client.js" async></script>
<script  src="server/payfast.client.js" async></script>
 <script src="server/twilioNotifiaction.js" async></script>
<script src="server/routes.js" async></script>
<script src="server/server.js" async></script>

<script  src="utils/payfastAPI.js" async></script>
</body>
</html>