<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Register Driver</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background-color: #f4f4f4;
}

.hidden {
  display: none;
}

form {
  max-width: 600px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 8px;
}

label {
  display: block;
  margin-top: 15px;
  font-weight: bold;
}

input, select {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  box-sizing: border-box;
}

.action-btn {
  margin-top: 20px;
  padding: 12px;
  width: 100%;
  background-color: #ff0000;
  color: #fff;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.action-btn:hover {
  background-color: #b30000;
}

#notification {
  text-align: center;
  margin-bottom: 15px;
}
</style>
</head>

<body>

<div id="notification" class="hidden"></div>
<div id="registerContent"></div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ===============================
   SUPABASE CONFIG (BROWSER SAFE)
================================ */
const supabaseUrl = 'https://wbpgmgtoyzlnawvsfeiu.supabase.co';
const supabaseKey = 'YOUR_PUBLIC_ANON_KEY_HERE'; // ðŸ”´ REQUIRED
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

/* ===============================
   NOTIFICATION
================================ */
function showNotificationMessage(message, color = '#4CAF50') {
  const notif = document.getElementById('notification');
  notif.innerHTML = `
    <div style="background:${color};color:#fff;padding:10px;border-radius:6px;">
      ${message}
    </div>`;
  notif.classList.remove('hidden');

  setTimeout(() => {
    notif.classList.add('hidden');
  }, 3000);
}

/* ===============================
   LOAD PAGE
================================ */
function loadNewDriverPage() {
  const container = document.getElementById('registerContent');

  container.innerHTML = `
    <div style="text-align:center">
      <img src="img/screenshot (251).jpg" alt="Welcome" style="width:250px;margin-bottom:20px">
    </div>

    <h1>Register as a Driver</h1>

    <form id="driverForm">
      <label>Upload Selfie:</label>
      <input type="file" id="driverPhoto" accept="image/*" required>

      <label>Name:</label>
      <input type="text" id="driverName" required>

      <label>Email:</label>
      <input type="email" id="driverEmail" required>

      <label>Password:</label>
      <input type="password" id="driverPassword" required>

      <label>Phone Number:</label>
      <input type="tel" id="driverPhone" required>

      <label>ID Number:</label>
      <input type="text" id="driverID" required>

      <label>Bank Account Number:</label>
      <input type="text" id="bankDetails" required>

      <label>Bank Name:</label>
      <select id="bankName" required>
        <option value="">Select Bank</option>
        <option value="FNB">FNB</option>
        <option value="Standard Bank">Standard Bank</option>
        <option value="Capitec">Capitec</option>
        <option value="Nedbank">Nedbank</option>
        <option value="Other">Other</option>
      </select>

      <div id="otherBankDiv" class="hidden">
        <label>Specify Bank:</label>
        <input type="text" id="otherBank">
      </div>

      <label>Driver License:</label>
      <input type="file" id="driverLicense" accept="image/*" required>

      <label>Car Color:</label>
      <input type="text" id="carColor" required>

      <label>Car Type:</label>
      <input type="text" id="carType" required>

      <label>Car Photo:</label>
      <input type="file" id="carPhoto" accept="image/*" required>

      <label>Car Registration Number:</label>
      <input type="text" id="carRegNumber" required>

      <button class="action-btn">Submit Registration</button>
    </form>
  `;

  document.getElementById('bankName').addEventListener('change', e => {
    document.getElementById('otherBankDiv')
      .classList.toggle('hidden', e.target.value !== 'Other');
  });

  document.getElementById('driverForm').addEventListener('submit', handleSubmit);
}

/* ===============================
   FORM SUBMIT
================================ */
async function handleSubmit(e) {
  e.preventDefault();

  try {
    showNotificationMessage('Uploading documents...');

    const driverPhotoURL = await uploadImage('register_driver_photos', driverPhoto.files[0]);
    const driverLicenseURL = await uploadImage('register_driver_licenses', driverLicense.files[0]);
    const carPhotoURL = await uploadImage('register_car_photos', carPhoto.files[0]);

    const driverData = {
      driver_photo_url: driverPhotoURL,
      name: driverName.value,
      email: driverEmail.value,
      password: driverPassword.value,
      phone_number: driverPhone.value,
      id_number: driverID.value,
      bank_details: bankDetails.value,
      bank_name: bankName.value,
      other_bank: otherBank.value || null,
      driver_license_url: driverLicenseURL,
      car_color: carColor.value,
      car_type: carType.value,
      car_photo_url: carPhotoURL,
      car_registration_number: carRegNumber.value,
      approved: false
    };

    const { error } = await supabase.from('register_drivers').insert([driverData]);
    if (error) throw error;

    showNotificationMessage('Registration successful!');
    setTimeout(() => {
      window.location.href = 'loginDriver.html';
    }, 1500);

  } catch (err) {
    console.error(err);
    showNotificationMessage('Registration failed', '#f44336');
  }
}

/* ===============================
   IMAGE UPLOAD
================================ */
async function uploadImage(bucket, file) {
  const filename = `${Date.now()}-${file.name}`;
  const { error } = await supabase.storage.from(bucket).upload(filename, file);
  if (error) throw error;

  return supabase.storage.from(bucket).getPublicUrl(filename).data.publicUrl;
}

loadNewDriverPage();
</script>
</body>
</html>
