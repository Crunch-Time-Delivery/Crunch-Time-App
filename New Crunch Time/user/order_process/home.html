<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Home Dashboard</title>
<style>
/* Basic Reset & Body */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
}

/* Header styles */
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
    background-color: #fff;
    border-bottom: 1px solid #ddd;
}
.header button {
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    padding: 5px 10px;
}
.header .search-bar {
    flex-grow: 1;
    margin: 0 10px;
}
.header .search-bar input {
    width: 100%;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

/* Filters Bar */
.filters {
    display: flex;
    justify-content: space-between;
    padding: 10px 20px;
    background-color: #ffb4b4;
    border-bottom: 1px solid #ddd;
    flex-wrap: wrap;
}
.filters button {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 5px;
    font-size: 14px;
}
.filters button img {
    width: 24px;
    height: 24px;
    margin-bottom: 5px;
}

/* Restaurant list styles */
.restaurant-list {
    padding: 10px 20px;
    max-height: 70vh;
    overflow-y: auto;
}
.restaurant-card {
    display: flex;
    background-color: #fff;
    margin-bottom: 10px;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    cursor: pointer;
    align-items: center;
    position: relative;
    transition: background 0.2s;
}
.restaurant-card img {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 10px;
}
.restaurant-card .details {
    flex-grow: 1;
}
.restaurant-card .rating {
    color: #666;
}
.restaurant-card .promo {
    color: red;
    font-weight: bold;
}
.restaurant-card button.heart {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    background-color: transparent;
}

/* Modal styles */
.modal {
    display: none; 
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
}
.modal-content {
    background-color: #fff;
    margin: 50px auto;
    padding: 20px;
    border-radius: 10px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: relative;
    animation: popin 0.3s ease;
}
@keyframes popin {
    from {transform: scale(0.9); opacity: 0;}
    to {transform: scale(1); opacity: 1;}
}
.close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
}

/* Restaurant modal image */
#restaurantImage {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 5px;
    margin-bottom: 10px;
}

/* Menu items in modal */
.menu-item {
    margin-bottom: 10px;
    cursor: pointer;
    padding: 8px;
    border: 1px solid #eee;
    border-radius: 4px;
    transition: background 0.2s;
}
.menu-item:hover {
    background-color: #f0f0f0;
}
.view-map-btn {
    display: inline-block;
    margin-top: 20px;
    padding: 10px 15px;
    background-color: #ff0000;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    text-decoration: none;
}

/* Food modal for adding items */
#foodModal {
    display: none;
    position: fixed; z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
}
#foodModalContent {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    position: relative;
    animation: popin 0.3s ease;
}
.food-close-btn {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 24px; font-weight: bold; cursor: pointer;
}
#foodItemName {
    margin-top: 0; margin-bottom: 10px;
}
.quantity-controls {
    display: flex; align-items: center; gap: 10px; margin-top: 10px;
}
.quantity-btn {
    padding: 5px 10px; font-size: 18px; cursor: pointer; background-color: #ddd; border: none; border-radius: 4px;
}

/* Order summary styles */
#orderSummary {
    padding: 10px 20px; background: #fff;
    max-height: 200px; overflow-y: auto; margin: 10px;
}
#orderSummary h4 { margin-top: 0; }
#orderItems li {
    margin-bottom: 8px; padding: 6px; background: #f7f7f7; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
}
#orderItems button {
    background-color: #b30000; color: #fff; border: none; border-radius: 3px; padding: 3px 8px; cursor: pointer; font-size: 12px;
}
/* Checkout page styles */
#checkoutPage {
    display: none; padding: 20px; background: #fff; max-width: 700px; margin: auto; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); margin-top: 20px;
}
#checkoutPage h2 { margin-top: 0; }
#checkoutItems { list-style: none; padding: 0; max-height: 150px; overflow-y: auto; }
#checkoutItems li { margin-bottom: 8px; padding: 6px; background: #f7f7f7; border-radius: 4px; }
#costBreakdown p { margin: 5px 0; }
#costBreakdown h3 { margin-top: 10px; }
#checkoutBtn {
    display: block; width: 100%; padding: 15px; background-color: #ff0000; color: #fff; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px;
}
#checkoutBtn:hover { background-color: #fb0404; }

/* Voucher modal styles */
#voucherModal {
    display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;
}
#voucherContent {
    background: #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; animation: popin 0.3s ease; position: relative;
}
#closeVoucher {
    position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer;
}
#voucherInput {
    width: 100%; padding: 8px; font-size: 16px; margin-top: 20px; border: 1px solid #ccc; border-radius: 5px;
}
#applyVoucher {
    margin-top: 15px; padding: 10px 20px; background-color:#f40505; border:none; border-radius:5px; color:#fff; font-size:16px; cursor:pointer;
}
#applyVoucher:hover { background-color: #f30404; }

#qrCodeContainer { margin-top: 20px; }
#qrCodePlaceholder {
    width: 150px; height: 150px; background: #eee; display: inline-block; line-height: 150px; color: #999; font-size: 14px; border-radius: 10px; text-align: center;
}

/* Order History Modal */
#orderHistoryModal {
    display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;
}
#orderHistoryModal .modal-content {
    max-width: 800px; width: 90%; padding: 20px; overflow-y: auto; max-height: 80%; background: #fff; border-radius: 10px;
}

/* Payment Modal */
#paymentModal {
    display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center;
}
#paymentModalContent {
    background: #fff; padding: 20px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); position: relative; animation: popin 0.3s ease;
}
#closePaymentModal {
    position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer;
}
#cardForm {
    display: flex; flex-direction: column; gap: 10px; margin-top: 10px;
}
#cardForm input {
    padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px;
}
#payButton {
    margin-top: 15px; padding: 10px; background-color: #f50505; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;
}
#payButton:hover { background-color: #f90303; }

</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <button>☰</button>
    <div>Crunch Time</div>
    <button>Delivery</button>
    <button>Pickup</button>
    <div class="search-bar">
        <input type="text" placeholder="Search Crunch Time ">
    </div>
    <button>Map Location - Pick up now</button>
</div>

<!-- FILTERS -->
<div class="filters">
    <button><img src="Images/Ultraprocessed foods display 2 framed - shutterstock_2137640529_r.jpg" alt="Fast Food"><span>Fast Food</span></button>
    <button><img src="Images/CR7 Veg .jpg" alt="Healthy"><span>Healthy</span></button>
    <button><img src="Images/CR7.jpg" alt="Burgers"><span>Burgers</span></button>
    <button><img src="Images/CR7 SUCCI.jpg" alt="Chinese"><span>Chinese</span></button>
    <button><img src="Images/CR7 WINGS.jpg" alt="Wings"><span>Wings</span></button>
    <button><img src="Images/CR7 PIZZA.webp" alt="Pizza"><span>Pizza</span></button>
    <button><img src="Images/CR7 SUCCI.webp" alt="Halal"><span>Halal</span></button>
    <button><img src="Images/CR7 KOREA.jpeg" alt="Korean"><span>Korean</span></button>
    <button>→</button>
</div>

<!-- RESTAURANT LIST -->
<div class="restaurant-list">
    <div class="restaurant-card" onclick="showMenu('KFC Parow')">
        <img src="Images/RS KFC.jpeg" alt="KFC Parow" />
        <div class="details">
            <div>KFC, Parow</div>
            <div class="rating">4.4 ★</div>
            <div>Sponsored - 5 min - 4.4 km</div>
        </div>
        <button class="heart" onclick="event.stopPropagation(); toggleFavorite(this)">♥</button>
    </div>
    <div class="restaurant-card" onclick="showMenu('Sannes Palace')">
        <img src="Images/RS PALACE.jpg" alt="Sannes Palace" />
        <div class="details">
            <div>Sannes Palace</div>
            <div class="rating">4.5 ★</div>
            <div class="promo">Spend ZAR 100, Save ZAR 15</div>
            <div>20 min - 0.5 km</div>
        </div>
        <button class="heart" onclick="event.stopPropagation(); toggleFavorite(this)">♥</button>
    </div>
    <div class="restaurant-card" onclick="showMenu('DK Spot & Kota')">
        <img src="Images/RS KOTA.jpg" alt="DK Spot & Kota" />
        <div class="details">
            <div>DK Spot & Kota Restaurant</div>
            <div class="rating">4.0 ★</div>
            <div>Uber Eats HDP-Owned - 16 min - 0.6 km</div>
        </div>
        <button class="heart" onclick="event.stopPropagation(); toggleFavorite(this)">♥</button>
    </div>
    <div class="restaurant-card" onclick="showMenu('Nondyebo Eatery')">
        <img src="Images/RS NONDYEBO.jpg" alt="Nondyebo Eatery" />
        <div class="details">
            <div>Nondyebo Eatery</div>
            <div class="rating">3.3 ★</div>
            <div>10 min - 0.6 km</div>
        </div>
        <button class="heart" onclick="event.stopPropagation(); toggleFavorite(this)">♥</button>
    </div>
</div>

<!-- Modal for Menu -->
<div id="menuModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <img id="restaurantImage" src="" alt="Restaurant Image" />
        <h2 id="restaurantName">Restaurant Menu</h2>
        <div id="menuItems"></div>
        <button class="view-map-btn" onclick="viewMap()">View Map Location</button>
    </div>
</div>

<!-- Food modal for adding items -->
<div id="foodModal">
    <div id="foodModalContent">
        <span class="food-close-btn" onclick="closeFoodModal()">&times;</span>
        <h3 id="foodItemName">Food Item</h3>
        <div style="display:flex; align-items:center; justify-content:space-around; margin-top:10px;">
            <button class="quantity-btn" onclick="changeQuantity(-1)">-</button>
            <span id="foodQuantity">1</span>
            <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
        </div>
        <div style="margin-top:20px; display:flex; justify-content:center;">
            <button class="add-more-btn" onclick="addItemToOrder()">Add More Items</button>
            <button class="exit-btn" onclick="closeFoodModal()">Exit</button>
        </div>
    </div>
</div>

<!-- Order Summary -->
<div id="orderSummary">
    <h4>Order Summary</h4>
    <ul id="orderItems"></ul>
    <button id="checkoutBtn" class="checkout-btn" onclick="goToCheckout()">Go to Checkout</button>
    <button id="orderHistoryBtn" class="add-more-btn" style="background-color:#b30000; margin-top:10px;" onclick="showOrderHistory()">My Order History</button>
    <div id="voucherSection">
        <button id="voucherButton" onclick="openVoucherModal()">Enter Voucher / Coupon</button>
    </div>
</div>

<!-- Contact details for driver (hidden initially, shown in checkout) -->
<div id="driverContact" style="margin-top:20px; padding:10px; background:#f0f0f0; border-radius:5px; display:none;">
    <h4>Contact Driver</h4>
    <p>Call: <a href="tel:+27123456789">+27 12 345 6789</a></p>
    <p>Message: <a href="sms:+27123456789">Send Message</a></p>
</div>

<!-- Popup for searching driver (hidden initially) -->
<div id="searchDriverPopup" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:#fff; padding:30px; border-radius:10px; text-align:center;">
        <h2>Searching for a driver...</h2>
        <p>Please wait while we assign a driver to your order.</p>
    </div>
</div>

<!-- Checkout page (hidden initially) -->
<div id="checkoutPage">
    <h2 id="checkoutRestaurantTitle">Checkout</h2>
    <h3>Order Breakdown</h3>
    <ul id="checkoutItems"></ul>
    <div id="costBreakdown" style="margin-top:10px;">
        <p>Subtotal: <span id="subtotalDisplay">R0.00</span></p>
        <!-- Removed VAT line -->
        <p>Service Fee: <span id="serviceFeeDisplay">R5.00</span></p>
        <p>Tip: <span id="tipDisplay">R3.00</span></p>
        <p>Delivery Fee: <span id="deliveryFeeDisplay">R10.00</span></p>
        <h3>Total (Tax Incl.): <span id="totalAmount">R0.00</span></h3>
        <p style="margin-top:10px; font-weight:bold;">Discount Applied: <span id="discountAmount">R0.00</span></p>
    </div>
    <h3>Payment Method</h3>
    <div style="margin-bottom:20px;">
        <!-- Payment options -->
        <label style="margin-right:15px;">
            <input type="radio" name="payment" value="EFT" checked> EFT Bank Transfer
        </label>
        <label style="margin-right:15px;">
            <input type="radio" name="payment" value="VISA"> <img src="https://img.icons8.com/color/48/000000/visa.png" style="width:24px; height:24px; vertical-align:middle; margin-right:5px;"> Visa
        </label>
        <label style="margin-right:15px;">
            <input type="radio" name="payment" value="MasterCard"> <img src="https://img.icons8.com/color/48/000000/mastercard-logo.png" style="width:24px; height:24px; vertical-align:middle; margin-right:5px;"> MasterCard
        </label>
        <label style="margin-right:15px;">
            <input type="radio" name="payment" value="AMEX"> <img src="https://img.icons8.com/color/48/000000/amex.png" style="width:24px; height:24px; vertical-align:middle; margin-right:5px;"> Amex
        </label>
    </div>
    <button class="pay-btn confirm-btn" onclick="confirmPayment()">Confirm Payment</button>
    <button class="pay-btn cancel-btn" onclick="cancelCheckout()">Cancel</button>
</div>

<!-- Voucher modal -->
<div id="voucherModal" style="display:none; justify-content:center; align-items:center;">
    <div id="voucherContent" style="background:#fff; padding:20px; border-radius:10px; width:90%; max-width:400px; animation:popin 0.3s ease; position:relative;">
        <span id="closeVoucher" onclick="closeVoucherModal()" style="position:absolute; top:10px; right:15px; font-size:24px; font-weight:bold; cursor:pointer;">&times;</span>
        <h3>Enter Voucher Code</h3>
        <input type="text" id="voucherInput" placeholder="Enter your coupon code" style="width:100%; padding:8px; font-size:16px; margin-top:20px; border:1px solid #ccc; border-radius:5px;">
        <button id="applyVoucher" onclick="applyVoucher()" style="margin-top:15px; padding:10px 20px; background-color:#f40505; border:none; border-radius:5px; color:#fff; font-size:16px; cursor:pointer;">Apply Coupon</button>
        <div id="qrCodeContainer" style="margin-top:20px; text-align:center;">
            <p>Or scan QR code:</p>
            <div id="qrCodePlaceholder" style="width:150px; height:150px; background:#eee; display:inline-block; line-height:150px; color:#999; font-size:14px; border-radius:10px;">[QR CODE IMAGE]</div>
        </div>
    </div>
</div>

<!-- Order History Modal -->
<div id="orderHistoryModal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeOrderHistory()" style="top:10px; right:15px;">&times;</span>
        <h2>My Order History</h2>
        <div id="orderHistoryList" style="max-height:400px; overflow-y:auto; margin-top:10px;"></div>
    </div>
</div>

<!-- Payment Gateway Modal -->
<div id="paymentModal">
  <div id="paymentModalContent" style="background:#fff; padding:20px; border-radius:10px; max-width:400px; width:90%; box-shadow:0 4px 12px rgba(0,0,0,0.2); position:relative; animation:popin 0.3s ease;">
    <span id="closePaymentModal" onclick="closePaymentGateway()" style="position:absolute; top:10px; right:15px; font-size:24px; font-weight:bold; cursor:pointer;">&times;</span>
    <h3>Enter Card Details</h3>
    <form id="cardForm">
      <input type="text" id="cardNumber" placeholder="Card Number" maxlength="19" required>
      <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5" required>
      <input type="text" id="cardCVV" placeholder="CVV" maxlength="4" required>
      <button type="button" id="payButton" style="margin-top:15px; padding:10px; background-color:#f40505; color:#fff; border:none; border-radius:5px; cursor:pointer; font-size:16px;" onclick="processCardPayment()">Pay</button>
    </form>
  </div>
</div>

<script>
// Placeholder menu data
const restaurantMenus = {
    "KFC Parow": [
        { name: "Zinger Burger", price: "R50" },
        { name: "Fries", price: "R20" },
        { name: "Cola", price: "R15" }
    ],
    "Sannes Palace": [
        { name: "Chicken Curry", price: "R80" },
        { name: "Veggie Plate", price: "R60" },
        { name: "Lemonade", price: "R10" }
    ],
    "DK Spot & Kota": [
        { name: "Kota Special", price: "R25" },
        { name: "Fries", price: "R20" },
        { name: "Soda", price: "R15" }
    ],
    "Nondyebo Eatery": [
        { name: "Wrap", price: "R40" },
        { name: "Salad", price: "R35" },
        { name: "Juice", price: "R12" }
    ]
};

let currentRestaurant = '';
let selectedFoodItem = null;
let currentQuantity = 1;
let orderItems = [];
let savedCards = [];
let appliedVoucher = null;
let discountAmount = 0;

// Fees
const SERVICE_FEE = 5.00;
const TIP = 3.00;
const DELIVERY_FEE = 10.00;

// Show menu
function showMenu(restaurantName) {
    currentRestaurant = restaurantName;
    document.getElementById('restaurantName').innerText = restaurantName + ' Menu';

    const imageElement = document.getElementById('restaurantImage');
    switch (restaurantName) {
        case 'KFC Parow': imageElement.src='Images/RS KFC.jpeg'; break;
        case 'Sannes Palace': imageElement.src='Images/RS PALACE.jpg'; break;
        case 'DK Spot & Kota': imageElement.src='Images/RS KOTA.jpg'; break;
        case 'Nondyebo Eatery': imageElement.src='Images/RS NONDYEBO.jpg'; break;
        default: imageElement.src=''; break;
    }

    const menuDiv = document.getElementById('menuItems');
    menuDiv.innerHTML='';
    const menuList = restaurantMenus[restaurantName] || [];
    menuList.forEach(item => {
        const div = document.createElement('div');
        div.className='menu-item';
        div.innerHTML=`<strong>${item.name}</strong> - ${item.price}`;
        div.onclick=()=>{ openFoodModal(item); };
        menuDiv.appendChild(div);
    });
    document.getElementById('menuModal').style.display='block';
}

function closeModal() { document.getElementById('menuModal').style.display='none'; }
function viewMap() {
    let url='';
    switch (currentRestaurant) {
        case 'KFC Parow': url='https://www.google.com/maps/search/?api=1&query=KFC+Parow'; break;
        case 'Sannes Palace': url='https://www.google.com/maps/search/?api=1&query=Sannes+Palace'; break;
        case 'DK Spot & Kota': url='https://www.google.com/maps/search/?api=1&query=DK+Spot+Kota'; break;
        case 'Nondyebo Eatery': url='https://www.google.com/maps/search/?api=1&query=Nondyebo+Eatery'; break;
        default: url='https://www.google.com/maps'; break;
    }
    window.open(url,'_blank');
}

window.onclick=function(event) {
    if (event.target==document.getElementById('menuModal')) closeModal();
    if (event.target==document.getElementById('foodModal')) closeFoodModal();
    if (event.target==document.getElementById('voucherModal')) closeVoucherModal();
    if (event.target==document.getElementById('orderHistoryModal')) closeOrderHistory();
    if (event.target==document.getElementById('paymentModal')) closePaymentGateway();
}

// Favorite toggle
function toggleFavorite(btn) {
    btn.innerText = (btn.innerText==='♥') ? '♡':'♥';
}

// Food modal
function openFoodModal(foodItem) {
    selectedFoodItem=foodItem;
    currentQuantity=1;
    document.getElementById('foodItemName').innerText=foodItem.name;
    document.getElementById('foodQuantity').innerText=currentQuantity;
    document.getElementById('foodModal').style.display='flex';
}
function closeFoodModal() { document.getElementById('foodModal').style.display='none'; }
function changeQuantity(delta) {
    currentQuantity+=delta;
    if (currentQuantity<1) currentQuantity=1;
    document.getElementById('foodQuantity').innerText=currentQuantity;
}
function addItemToOrder() {
    if (selectedFoodItem) {
        // Ask for opinion
        const opinion = prompt(`How do you want your ${selectedFoodItem.name}? (e.g., Spicy, Less Salt, No Onion, etc.)`, '');
        if (opinion !== null) {
            selectedFoodItem.opinion = opinion;
        }
        orderItems.push({ 
            name: selectedFoodItem.name, 
            price: selectedFoodItem.price, 
            quantity: currentQuantity,
            opinion: selectedFoodItem.opinion || 'No preference'
        });
        updateOrderSummary();
    }
    closeFoodModal();
}

// Update order summary to include opinions
function updateOrderSummary() {
    const ul=document.getElementById('orderItems');
    ul.innerHTML='';
    orderItems.forEach((item,index) => {
        const li=document.createElement('li');
        li.innerHTML=`${item.name} x${item.quantity} ${item.price} <br/>Opinion: ${item.opinion}`;
        const removeBtn=document.createElement('button');
        removeBtn.innerText='Remove';
        removeBtn.onclick=()=>{ orderItems.splice(index,1); updateOrderSummary(); };
        li.appendChild(removeBtn);
        ul.appendChild(li);
    });
}

// Save order to history
function saveOrderToHistory() {
    let history = JSON.parse(localStorage.getItem('orderHistory')) || [];
    const timestamp = new Date().toISOString();
    const totalText = document.getElementById('totalAmount').innerText;
    history.push({ timestamp, restaurant: currentRestaurant, items: [...orderItems], total: totalText });
    localStorage.setItem('orderHistory', JSON.stringify(history));
}

function showOrderHistory() {
    const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
    const container = document.getElementById('orderHistoryList');
    container.innerHTML='';

    if (history.length === 0) {
        container.innerHTML='<p>No order history available.</p>';
    } else {
        history.slice().reverse().forEach((entry, index) => {
            const div = document.createElement('div');
            div.style.border='1px solid #ccc';
            div.style.borderRadius='5px';
            div.style.padding='10px';
            div.style.marginBottom='10px';
            div.innerHTML = `
                <strong>${new Date(entry.timestamp).toLocaleString()}</strong><br/>
                Restaurant: ${entry.restaurant}<br/>
                Total: ${entry.total}
                <button style="margin-top:5px; background-color:#b30000; color:#fff; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;" onclick='viewOrderDetails(${index})'>View</button>
            `;
            container.appendChild(div);
        });
    }
    document.getElementById('orderHistoryModal').style.display='flex';
}

function viewOrderDetails(index) {
    const history = JSON.parse(localStorage.getItem('orderHistory')) || [];
    const order = history.slice().reverse()[index];
    alert(`Order Details:\nRestaurant: ${order.restaurant}\nTotal: ${order.total}\nItems:\n` + order.items.map(i => `${i.name} x${i.quantity} @ ${i.price} Opinion: ${i.opinion}`).join('\n'));
}
function closeOrderHistory() {
    document.getElementById('orderHistoryModal').style.display='none';
}

// Main checkout
function goToCheckout() {
    if (orderItems.length===0) { alert("Your cart is empty!"); return; }
    // Save current order
    saveOrderToHistory();

    document.getElementById('checkoutRestaurantTitle').innerText = currentRestaurant + ' - Checkout';

    const ul=document.getElementById('checkoutItems');
    ul.innerHTML='';

    let subtotal=0;
    orderItems.forEach(item => {
        const li=document.createElement('li');
        const priceNum=parseFloat(item.price.replace('R','').trim());
        const totalItemPrice=priceNum*item.quantity;
        subtotal+=totalItemPrice;
        li.innerHTML=`${item.name} x${item.quantity} ${item.price} = R${totalItemPrice.toFixed(2)}`;
        ul.appendChild(li);
    });

    // VAT is included, so omit VAT line
    // const vat=subtotal*0.15; // Removed
    let total=subtotal+SERVICE_FEE+TIP+DELIVERY_FEE;

    if (appliedVoucher) {
        total -= discountAmount;
        if (total<0) total=0;
    }

    // Update display
    document.getElementById('subtotalDisplay').innerText=`R${subtotal.toFixed(2)}`;
    // VAT line removed
    document.getElementById('serviceFeeDisplay').innerText=`R${SERVICE_FEE.toFixed(2)}`;
    document.getElementById('tipDisplay').innerText=`R${TIP.toFixed(2)}`;
    document.getElementById('deliveryFeeDisplay').innerText=`R${DELIVERY_FEE.toFixed(2)}`;
    document.getElementById('totalAmount').innerText=`R${total.toFixed(2)}`;
    document.getElementById('discountAmount').innerText=`R${discountAmount.toFixed(2)}`;

    // Show contact details for driver
    document.getElementById('driverContact').style.display='block';

    // Show the driver search popup
    document.getElementById('searchDriverPopup').style.display='flex';

    // Simulate driver search delay, then hide popup
    setTimeout(() => {
        document.getElementById('searchDriverPopup').style.display='none';
        alert('Driver has been assigned! Your driver will arrive shortly.');
    }, 3000); // 3 seconds delay
    // Show checkout
    document.getElementById('checkoutPage').style.display='block';
    document.querySelector('#orderSummary').style.display='none';
}

function cancelCheckout() {
    document.getElementById('checkoutPage').style.display='none';
    document.querySelector('#orderSummary').style.display='block';
    // Hide driver contact
    document.getElementById('driverContact').style.display='none';
}

// Get selected payment method
function getSelectedPaymentMethod() {
    const radios=document.getElementsByName('payment');
    for (let r of radios) {
        if (r.checked) return r.value;
    }
    return 'EFT';
}

// Confirm payment
function confirmPayment() {
    const method = getSelectedPaymentMethod();
    if (method === 'EFT') {
        alert(`Your payment of ${document.getElementById('totalAmount').innerText} via EFT Bank Transfer has been processed successfully. Thank you!`);
        clearOrder();
    } else {
        // For card methods, open modal
        openPaymentGateway();
    }
}

// Clear order
function clearOrder() {
    orderItems = [];
    updateOrderSummary();
    cancelCheckout();
    // Hide driver contact after order
    document.getElementById('driverContact').style.display='none';
}

// ------------------- Payment Gateway Functions -------------------
function openPaymentGateway() {
    document.getElementById('paymentModal').style.display='flex';
}
function closePaymentGateway() {
    document.getElementById('paymentModal').style.display='none';
}
function processCardPayment() {
    const number = document.getElementById('cardNumber').value.trim();
    const expiry = document.getElementById('cardExpiry').value.trim();
    const cvv = document.getElementById('cardCVV').value.trim();

    if (!number || !expiry || !cvv) {
        alert('Please fill all card details.');
        return;
    }

    // Basic validation
    if (number.length < 13 || number.length > 19 || isNaN(number.replace(/\s+/g,""))) {
        alert('Invalid card number.');
        return;
    }
    if (!/^\d{2}\/\d{2}$/.test(expiry)) {
        alert('Invalid expiry format.');
        return;
    }
    if (cvv.length < 3 || cvv.length > 4 || isNaN(cvv)) {
        alert('Invalid CVV.');
        return;
    }

    // Mask card number: show only last 4 digits
    const maskedNumber='**** **** **** ' + number.slice(-4);
    alert(`Payment of ${document.getElementById('totalAmount').innerText} successful via card ending with ${number.slice(-4)}!`);
    closePaymentGateway();
    document.getElementById('cardForm').reset();

    // Save card info temporarily with masked number
    const cardInfo = {
        number: maskedNumber,
        expiry: expiry,
        cvv: cvv
    };
    savedCards.push(cardInfo);

    // Show driver search popup after payment
    document.getElementById('searchDriverPopup').style.display='flex';

    // Simulate driver assignment delay
    setTimeout(() => {
        document.getElementById('searchDriverPopup').style.display='none';
        alert('Driver has been assigned! Your driver will arrive shortly.');
    }, 3000); // 3 seconds

    // Clear order after payment
    clearOrder();
}

// When user selects a card payment, open modal
function onPaymentMethodChange() {
    const radios = document.getElementsByName('payment');
    for (let r of radios) {
        if (r.checked && r.value !== 'EFT') {
            openPaymentGateway();
            break;
        }
    }
}

// Attach event listener for radio buttons
window.onload = function() {
    document.getElementById('driverContact').style.display='none'; // hide contact initially
    const radios = document.getElementsByName('payment');
    for (let r of radios) {
        r.onclick=onPaymentMethodChange;
    }
};

// ------------------ Voucher functions ------------------
function openVoucherModal() {
    document.getElementById('voucherModal').style.display='flex';
}
function closeVoucherModal() {
    document.getElementById('voucherModal').style.display='none';
}
function applyVoucher() {
    const code = document.getElementById('voucherInput').value.trim();
    if (code === 'SAVE10') {
        alert('Voucher applied! R10 off.');
        discountAmount = 10;
        appliedVoucher = 'SAVE10';
    } else if (code === 'FREESHIP') {
        alert('Free delivery voucher applied! (simulated)');
    } else {
        alert('Invalid voucher code.');
        discountAmount = 0;
        appliedVoucher = null;
    }
    closeVoucherModal();
}

// ------------------- Utility functions -------------------
function closeOrderHistory() {
    document.getElementById('orderHistoryModal').style.display='none';
}
</script>
</body>
</html>