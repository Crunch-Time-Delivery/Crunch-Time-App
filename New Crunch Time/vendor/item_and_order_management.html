<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vendor Dashboard</title>
<!-- Font Awesome for icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
  body {
    font-family: sans-serif;
    background-color: #f9f9f9;
    margin: 0;
  }

  /* Header styles */
  .header {
    position: fixed;
    top: 0;
    width: 100%;
    height: 60px;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    padding: 0 20px;
    z-index: 999;
  }

  /* Vendor label on left */
  .vendor-text {
    font-weight: bold;
    color: red;
    font-size: 1.2em;
  }

  /* Menu container with right alignment */
  .menu-container {
    margin-left: auto; /* pushes to the right side */
    display: flex;
    align-items: center;
    position: relative;
  }

  /* Menu button style */
  .profile-btn {
    background: #ff0000;
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
  }
  .profile-btn:hover {
    background: #b30000;
  }

  /* Dropdown menu styles */
  .dropdown {
    display: none;
    position: absolute;
    right: 0;
    top: 50px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    min-width: 200px;
    z-index: 1000;
  }
  .dropdown.show {
    display: block;
  }
  .dropdown a {
    display: block;
    padding: 10px 15px;
    text-decoration: none;
    color: #333;
  }
  .dropdown a:hover {
    background: #f0f0f0;
  }

  /* Container for page content, with top padding to account for fixed header */
  .container {
    max-width: 1200px;
    margin: 80px auto 20px; /* margin-top to clear the header */
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  /* Sections */
  h2 {
    margin-top: 0;
    text-align: center;
    margin-bottom: 20px;
  }

  /* Modal overlays for Register, OTP, Login */
  .modal {
    display: flex; align-items: center; justify-content: center;
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 9999;
  }
  .modal-box {
    background: #fff; padding: 30px; border-radius: 8px; width: 350px; max-height: 80%; overflow-y: auto;
  }

  /* Item Management styles */
 .item-section {
    margin-top: 30px;
  }
  .item-form {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-end;
  }
  .item-form div {
    display: flex;
    flex-direction: column;
  }
  .item-form label {
    margin-bottom: 5px;
  }
  .item-form input {
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 200px;
  }
  #addItemBtn {
    padding: 10px 15px;
    background-color: #e70e0e;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #addItemBtn:hover {
    background-color: #d00c0c;
  }
  #item-table {
    margin-top: 20px;
  }
  #item-table table {
    width: 100%;
    border-collapse: collapse;
  }
  #item-table th, #item-table td {
    border: 1px solid #ccc;
    padding: 8px;
  }
  #item-table th {
    background-color: #f0f0f0;
  }
  /* Food image preview */
  #foodImagePreview {
    width: 100px;
    height: auto;
    display: none;
    margin-top: 10px;
  }

  /* Order Management styles */
 .order-section {
    margin-top: 50px;
  }
  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .filter-section {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  select {
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #addOrderBtn {
    padding: 8px 12px;
    background-color: #f10b0b;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  #addOrderBtn:hover {
    background-color: #f20606;
  }
  table#ordersTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  #ordersTable th, #ordersTable td {
    border: 1px solid #ccc;
    padding: 8px;
  }
  #ordersTable th {
    background-color: #f0f0f0;
  }
  button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .view-btn { background-color: #ec1313; color:#fff; }
  .update-btn { background-color: #f10d0d; color:#fff; }
  .remove-btn { background-color: #f51808; color:#fff; }
  .add-btn { background-color: #f21010; color:#fff; }
  button:hover {
    opacity: 0.9;
  }
</style>
</head>
<body>

<!-- Register Modal -->
<div id="registerModal" class="modal" style="display:flex;">
  <div class="modal-box">
    <h3>Register New Vendor</h3>
    <input type="email" id="regEmail" placeholder="Invitation Email" style="width:100%; margin-bottom:10px; padding:8px;"/>
    <input type="text" id="regName" placeholder="Full Name" style="width:100%; margin-bottom:10px; padding:8px;"/>
    <input type="password" id="regPassword" placeholder="Password" style="width:100%; margin-bottom:10px; padding:8px;"/>
    <button style="width:100%;" onclick="startRegistration()">Create Account</button>
  </div>
</div>

<!-- OTP Modal -->
<div id="otpModal" class="modal" style="display:none;">
  <div class="modal-box">
    <h3>Enter OTP</h3>
    <input type="text" id="otpInput" placeholder="OTP" style="width:100%; margin-bottom:10px; padding:8px;"/>
    <button style="width:100%;" onclick="verifyOTP()">Verify OTP</button>
  </div>
</div>

<!-- Login Modal -->
<div id="loginModal" class="modal" style="display:none;">
  <div class="modal-box">
    <h3>Vendor Login</h3>
    <input type="text" id="username" placeholder="Username" style="width:100%; margin-bottom:10px; padding:8px;"/>
    <input type="password" id="password" placeholder="Password" style="width:100%; margin-bottom:10px; padding:8px;"/>
    <button style="width:100%;" onclick="verifyLogin()">Login</button>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="vendor-text">Vendor</div>
  
  <!-- Menu button on the right -->
  <div class="menu-container">
    <button class="profile-btn" id="profileBtn" style="margin-right:10px;">
      <i class="fas fa-user-circle"></i> Menu
    </button>
    <div class="dropdown" id="profileDropdown">
      <a href="http://127.0.0.1:5500/New%20Crunch%20Time/vendor/item_and_order_management.html" id="menuItem">Item & Order Management</a>
      <a href="http://127.0.0.1:5500/New%20Crunch%20Time/vendor/item_and_order_management.html" id="menuUsers">Manage Users</a>
      <a href="http://127.0.0.1:5500/New%20Crunch%20Time/vendor/payment_mangement.html" id="menuPayment">Payment Management</a>
      <a href="#" onclick="logout()">Logout</a>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container" id="mainContent">

  <!-- Item Management -->
  <div class="item-section" id="itemSection">
    <h2>Item Management</h2>
    <div class="item-form">
      <div>
        <label for="vendor">Vendor:</label>
        <input type="text" id="vendor" placeholder="Vendor Name" />
      </div>
      <div>
        <label for="item">Item:</label>
        <input type="text" id="item" placeholder="Item Name" />
      </div>
      <div>
        <label for="price">Price:</label>
        <input type="number" id="price" placeholder="Price" />
      </div>
      <div>
        <label for="foodImage">Food Image:</label>
        <input type="file" accept="image/*" id="foodImage" />
        <img id="foodImagePreview" src="#" alt="Food Image Preview" />
      </div>
      <div>
        <button id="addItemBtn" onclick="addItem()">Add Item</button>
      </div>
    </div>
    <div id="item-table"></div>
  </div>

  <!-- Order Management -->
  <div class="order-section" id="orderSection" style="display:none;">
    <h2>Order Management</h2>
    <div class="order-header">
      <button id="addOrderBtn" onclick="promptAddOrder()">Add Order</button>
      <div class="filter-section">
        <label for="orderFilter">Filter by status:</label>
        <select id="orderFilter" onchange="filterOrders()">
          <option value="All">All</option>
          <option value="Pending">Pending</option>
          <option value="Delivered">Delivered</option>
        </select>
      </div>
    </div>
    <table id="ordersTable">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Total</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

</div>

<!-- Scripts -->
<script>
// Check if vendor already logged in or registered
if(localStorage.getItem('vendorLoggedIn')==='true'){
  showSection('itemSection');
} else {
  // Show login modal if not logged in
  showLogin();
}

// Function to show sections
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
}

// Registration & OTP handling
let tempAdminData = {};
let generatedOTP = '';

// Function to simulate sending OTP via email & SMS to admin
function sendOTPNotification(otp) {
  // Replace URL with your backend API to send email/SMS
  fetch('https://yourserver.com/send-notification', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: 'crunchtimedrivein@gmail.com', // admin email
      phone: '1234567890', // admin phone number
      message: `New OTP for vendor registration: ${otp}`
    })
  }).then(res => {
    if(res.ok) console.log('OTP notification sent via email & SMS.');
    else console.error('Failed to send OTP notification.');
  }).catch(e => console.error('Error:', e));
}

function startRegistration() {
  const email = document.getElementById('regEmail').value.trim();
  const name = document.getElementById('regName').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  if(!name || !password || !email){
    alert('Fill all fields.');
    return;
  }
  // Save credentials temporarily
  window.tempAdminData = {email, name, password};
  window.generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
  // Send OTP via email & SMS
  sendOTPNotification(window.generatedOTP);
  alert('Your OTP is: ' + window.generatedOTP);
  document.getElementById('registerModal').style.display='none';
  document.getElementById('otpModal').style.display='flex';
}

function verifyOTP() {
  const inputOTP = document.getElementById('otpInput').value.trim();
  if(inputOTP===window.generatedOTP){
    alert('OTP verified! Sending notification...');
    sendNotificationEmail();
    // Save login info
    localStorage.setItem('vendorLoggedIn', 'true');
    localStorage.setItem('vendorEmail', window.tempAdminData.email);
    localStorage.setItem('vendorPassword', window.tempAdminData.password);
    // Hide modal
    document.getElementById('otpModal').style.display='none';
    showSection('itemSection');
  } else {
    alert('Incorrect OTP.');
  }
}

// Login
function showLogin() {
  document.getElementById('loginModal').style.display='flex';
}
function verifyLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const storedEmail = localStorage.getItem('vendorEmail');
  const storedPass = localStorage.getItem('vendorPassword');
  if(!storedEmail || !storedPass){
    alert('No vendor registered. Please register first.');
    return;
  }
  if(username===storedEmail && password===storedPass){
    alert('Login successful!');
    document.getElementById('loginModal').style.display='none';
    localStorage.setItem('vendorLoggedIn', 'true');
    showSection('itemSection');
  } else {
    alert('Invalid credentials.');
  }
}

// Send email notification (simulate)
function sendNotificationEmail() {
  fetch('https://yourserver.com/send-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      to: 'crunchtimedrivein@gmail.com',
      subject: 'New Vendor Registration',
      message: 'A new vendor has registered on your platform.'
    })
  }).then(res => {
    if(res.ok) console.log('Notification sent.');
    else console.error('Failed to send notification.');
  }).catch(e => console.error('Error:', e));
}

// Logout
function logout() {
  localStorage.removeItem('vendorLoggedIn');
  localStorage.removeItem('vendorEmail');
  localStorage.removeItem('vendorPassword');
  alert('Logged out.');
  showLogin();
}

// Menu toggle for dropdown
const profileBtn = document.getElementById('profileBtn');
const profileDropdown = document.getElementById('profileDropdown');
profileBtn.onclick = () => {
  profileDropdown.classList.toggle('show');
};
window.onclick = (e) => {
  if (!e.target.closest('.menu-container')) {
    profileDropdown.classList.remove('show');
  }
};

// Item Management
let items = [];
function addItem() {
  const vendor = document.getElementById('vendor').value.trim();
  const item = document.getElementById('item').value.trim();
  const price = parseFloat(document.getElementById('price').value);
  const imageFile = document.getElementById('foodImage').files[0];
  if(!vendor || !item || isNaN(price)){
    alert('Fill all fields correctly.');
    return;
  }
  if(imageFile){
    const reader=new FileReader();
    reader.onload=function(e){
      saveItem(vendor, item, price, e.target.result);
      resetItemForm();
    }
    reader.readAsDataURL(imageFile);
  } else {
    saveItem(vendor, item, price, '');
    resetItemForm();
  }
}
function saveItem(vendor, item, price, imageData){
  // Default stock status as 'In Stock'
  items.push({vendor, item, price, imageData, stock:'In Stock'});
  displayItems();
}
function resetItemForm() {
  document.getElementById('vendor').value='';
  document.getElementById('item').value='';
  document.getElementById('price').value='';
  document.getElementById('foodImage').value='';
  document.getElementById('foodImagePreview').style.display='none';
}
function displayItems() {
  const container=document.getElementById('item-table');
  container.innerHTML='';
  if(items.length===0){ container.innerHTML='<p>No items added.</p>'; return; }
  const table=document.createElement('table');
  table.innerHTML=`
    <thead>
      <tr>
        <th>Vendor</th><th>Item</th><th>Price</th><th>Image</th><th>Stock Status</th><th>Actions</th>
      </tr>
    </thead>`;
  const tbody=document.createElement('tbody');
  items.forEach((it, idx)=>{
    const row=tbody.insertRow();
    row.insertCell().innerText=it.vendor;
    row.insertCell().innerText=it.item;
    row.insertCell().innerText=`R ${it.price.toFixed(2)}`;
    const imgCell=row.insertCell();
    if(it.imageData){
      const img=document.createElement('img');
      img.src=it.imageData; img.width=50; alt='Food';
      imgCell.appendChild(img);
    }else{
      imgCell.innerText='No Image';
    }
    // Stock Status Cell
    const stockCell=row.insertCell();
    stockCell.innerText=it.stock;
    // Actions Cell
    const actionsCell=row.insertCell();
    // "Out of Stock" toggle button
    const outOfStockBtn=document.createElement('button');
    outOfStockBtn.innerText=it.stock==='In Stock'?'Mark Out of Stock':'Mark In Stock';
    outOfStockBtn.onclick=()=>toggleStockStatus(idx);
    actionsCell.appendChild(outOfStockBtn);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}
// Toggle stock status
function toggleStockStatus(index){
  items[index].stock= items[index].stock==='In Stock'?'Out of Stock':'In Stock';
  displayItems();
}

// Food Image Preview
document.getElementById('foodImage').addEventListener('change', function() {
  const preview=document.getElementById('foodImagePreview');
  if(this.files && this.files[0]){
    const reader=new FileReader();
    reader.onload=(e)=>{
      preview.src=e.target.result;
      preview.style.display='block';
    }
    reader.readAsDataURL(this.files[0]);
  }else{
    preview.style.display='none';
  }
});

// Order Management
let orders = [
  { id: 1, customer: 'Alice', total: 120.50, status: 'Pending' },
  { id: 2, customer: 'Bob', total: 75.00, status: 'Delivered' },
  { id: 3, customer: 'Charlie', total: 200.00, status: 'Pending' }
];

function displayOrders(filter='All'){
  const tbody=document.getElementById('ordersBody');
  tbody.innerHTML='';
  const filtered= filter==='All' ? orders : orders.filter(o=>o.status===filter);
  filtered.forEach(o=>{
    const row=tbody.insertRow();
    row.insertCell().innerText=o.id;
    row.insertCell().innerText=o.customer;
    row.insertCell().innerText=`R ${o.total.toFixed(2)}`;
    row.insertCell().innerText=o.status;
    const actions=row.insertCell();
    actions.innerHTML=`
      <button class="view-btn" onclick="viewOrder(${o.id})">View</button>
      <button class="update-btn" onclick="updateOrder(${o.id})">Update</button>
      <button class="remove-btn" onclick="removeOrder(${o.id})">Remove</button>
    `;
  });
}
function filterOrders() {
  const val=document.getElementById('orderFilter').value;
  displayOrders(val);
}
function viewOrder(id){ alert('Viewing order #'+id); }
function updateOrder(id){
  const order=orders.find(o=>o.id===id);
  if(order){
    const newStatus=prompt('Enter status (Pending/Delivered):', order.status);
    if(newStatus==='Pending'||newStatus==='Delivered'){
      order.status=newStatus;
      filterOrders();
    }else{
      alert('Invalid status');
    }
  }
}
function removeOrder(id){
  if(confirm('Remove order #'+id+'?')){
    orders=orders.filter(o=>o.id!==id);
    filterOrders();
  }
}
function promptAddOrder() {
  const customer=prompt('Customer Name:');
  const totalStr=prompt('Total in R:');
  const status=prompt('Status (Pending/Delivered):');
  const total=parseFloat(totalStr);
  if(customer && !isNaN(total) && (status==='Pending'||status==='Delivered')){
    const newId=orders.length>0?Math.max(...orders.map(o=>o.id))+1:1;
    orders.push({id:newId, customer, total, status});
    filterOrders();
  }else{
    alert('Invalid input.');
  }
}

// Utility to show sections
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  document.getElementById(id).style.display='block';
}

// Registration modal trigger (optional button)
function registerVendor() {
  if(localStorage.getItem('vendorLoggedIn')!=='true'){
    document.getElementById('registerModal').style.display='flex';
  } else {
    showSection('itemSection');
  }
}

// Registration process
function startRegistration() {
  const email = document.getElementById('regEmail').value.trim();
  const name = document.getElementById('regName').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  if(!name || !password || !email){
    alert('Fill all fields.');
    return;
  }
  // Save credentials temporarily
  window.tempAdminData = {email, name, password};
  window.generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
  // Send OTP via email & SMS
  sendOTPNotification(window.generatedOTP);
  alert('Your OTP is: ' + window.generatedOTP);
  document.getElementById('registerModal').style.display='none';
  document.getElementById('otpModal').style.display='flex';
}

function verifyOTP() {
  const inputOTP = document.getElementById('otpInput').value.trim();
  if(inputOTP===window.generatedOTP){
    alert('OTP verified! Sending notification...');
    sendNotificationEmail();
    // Save login info
    localStorage.setItem('vendorLoggedIn', 'true');
    localStorage.setItem('vendorEmail', window.tempAdminData.email);
    localStorage.setItem('vendorPassword', window.tempAdminData.password);
    // Hide modal
    document.getElementById('otpModal').style.display='none';
    showSection('itemSection');
  } else {
    alert('Incorrect OTP.');
  }
}

// Login
function showLogin() {
  document.getElementById('loginModal').style.display='flex';
}
function verifyLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  const storedEmail = localStorage.getItem('vendorEmail');
  const storedPass = localStorage.getItem('vendorPassword');
  if(!storedEmail || !storedPass){
    alert('No vendor registered. Please register first.');
    return;
  }
  if(username===storedEmail && password===storedPass){
    alert('Login successful!');
    document.getElementById('loginModal').style.display='none';
    localStorage.setItem('vendorLoggedIn', 'true');
    showSection('itemSection');
  } else {
    alert('Invalid credentials.');
  }
}

// Send email notification (simulate)
function sendNotificationEmail() {
  fetch('https://yourserver.com/send-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      to: 'crunchtimedrivein@gmail.com',
      subject: 'New Vendor Registration',
      message: 'A new vendor has registered on your platform.'
    })
  }).then(res => {
    if(res.ok) console.log('Notification sent.');
    else console.error('Failed to send notification.');
  }).catch(e => console.error('Error:', e));
}
</script>
</body>
</html>