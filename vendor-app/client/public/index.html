<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vendor App</title>
<!-- Font Awesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
<style>
  body { font-family: sans-serif; background:#f0f0f0; margin:0; }
  .header { position: fixed; top:0; width:100%; height:60px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); z-index:999; }
  .vendor-text { font-weight:bold; color:red; font-size:1.2em; }
  .menu-container { display: flex; align-items: center; position: relative; margin-left: -20px; }
  .profile-btn { background:#ff0000; color:#fff; padding:8px 12px; border:none; border-radius:50px; cursor:pointer; }
  .dropdown { display:none; position:absolute; right:20px; top:60px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.2); min-width:200px; z-index:1000; }
  .dropdown.show { display:block; }
  .dropdown a { display:block; padding:10px 15px; text-decoration:none; color:#333; }
  .dropdown a:hover { background:#f0f0f0; }
  .container { margin-top:80px; padding:20px; max-width:1200px; margin-left:auto; margin-right:auto; background:#fff; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
  /* Buttons */
  .section { margin-top:20px; }
  .red-button { background-color: #f60202; color: #fff; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 1em; margin: 10px 0; }
  /* Forms */
  .form-container { background: #fff; padding: 20px; border-radius: 8px; max-width: 500px; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .form-container input, .form-container select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
  /* Table styles */
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; }
  th { background:#f0f0f0; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="vendor-text">Vendor</div>
  <div class="menu-container">
    <button class="profile-btn" id="profileBtn" onclick="toggleDropdown()">
      <i class="fas fa-user-circle"></i> Menu
    </button>
    <div class="dropdown" id="profileDropdown">
      <a href="#" onclick="showManagement('items'); return false;">Manage Items</a>
      <a href="#" onclick="showManagement('orders'); return false;">Manage Orders</a>
      <a href="#" onclick="showManagement('payment'); return false;">Payment History</a>
      <a href="#" onclick="logout(); return false;">Logout</a>
    </div>
  </div>
</div>

<div class="container">
  <!-- Management Buttons -->
  <div class="management-buttons">
    <button class="red-button" onclick="showSection('menuUpload')">Upload Restaurant Menu</button>
    <button class="red-button" onclick="showSection('restaurantInfo')">Enter Restaurant Info</button>
    <button class="red-button" onclick="showSection('addItem')">Add Item</button>
    <button class="red-button" onclick="showSection('addOrder')">Add Order</button>
    <button class="red-button" onclick="fetchPayments()">Payment History</button>
  </div>

  <!-- Sections -->
  <div id="section-menuUpload" class="section" style="display:none;">
    <h3>Upload Restaurant Menu (PDF)</h3>
    <div class="form-container">
      <input type="text" id="restaurantName" placeholder="Restaurant Name" />
      <input type="file" id="menuFile" accept="application/pdf" />
      <button class="red-button" onclick="uploadMenu()">Upload Menu</button>
    </div>
  </div>

  <div id="section-restaurantInfo" class="section" style="display:none;">
    <h3>Enter Restaurant Details</h3>
    <div class="form-container">
      <input type="text" id="restName" placeholder="Restaurant Name" />
      <input type="text" id="contact" placeholder="Contact" />
      <input type="text" id="website" placeholder="Website" />
      <input type="text" id="address" placeholder="Address" />
      <button class="red-button" onclick="saveRestaurantInfo()">Save Details</button>
    </div>
  </div>

  <!-- Add Item -->
<div id="section-addItem" class="section" style="display:none;">
  <h3>Add Menu Item</h3>

  <div class="form-container">

    <!-- Vendor Info -->
    <input type="text" id="itemVendor" placeholder="Restaurant / Vendor Name" />

    <!-- Basic Item Info -->
    <input type="text" id="itemName" placeholder="Item Name (e.g. Chicken Burger)" />

    <textarea id="itemDescription" placeholder="Item Description"></textarea>

    <!-- Category -->
    <select id="itemCategory">
      <option value="">Select Category</option>
      <option value="Fast Food">Fast Food</option>
      <option value="Burgers">Burgers</option>
      <option value="Pizza">Pizza</option>
      <option value="Healthy">Healthy</option>
      <option value="Asian">Asian

    </select>

    <!-- Pricing -->
    <input type="number" id="itemPrice" placeholder="Price (ZAR)" />

    <input type="number" id="itemDiscount" placeholder="Discount % (optional)" />

    <!-- Portion & Prep -->
    <input type="text" id="itemPortion" placeholder="Portion Size (e.g. Large)" />

    <input type="number" id="prepTime" placeholder="Prep Time (minutes)" />

    <!-- Dietary -->
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <label><input type="checkbox" id="isVeg"> Vegetarian</label>
      <label><input type="checkbox" id="isSpicy"> Spicy</label>
    </div>

    <!-- Stock -->
    <select id="itemStock">
      <option value="In Stock">In Stock</option>
      <option value="Out of Stock">Out of Stock</option>
    </select>

    <!-- Image -->
    <input type="file" id="itemImage" accept="image/*" />

    <!-- Save -->
    <button class="red-button" onclick="addItem()">
      Save Item
    </button>

  </div>
</div>


  <!-- Add Order -->
  <div id="section-addOrder" class="section" style="display:none;">
    <h3>Add Order</h3>
    <div class="form-container">
      <input type="text" id="orderId" placeholder="Order ID" />
      <input type="text" id="orderUserName" placeholder="User Name" />
      <input type="email" id="orderUserEmail" placeholder="User Email" />
      <input type="number" id="orderAmount" placeholder="Amount" />
      <button class="red-button" onclick="addOrder()">Save Order</button>
    </div>
  </div>

 

  <!-- Payment History -->
  <div id="section-payment" class="section" style="display:none;">
    <h3>Payment History</h3>
    <button class="red-button" onclick="fetchPayments()">Refresh</button>
    <div id="paymentHistoryContainer"></div>
  </div>

  <!-- Placeholder for other sections like Items, Orders, Users -->
  <div id="section-items" class="section" style="display:none;">
    <h3>Items</h3>
    <div id="itemsTable"></div>
  </div>
  <div id="section-orders" class="section" style="display:none;">
    <h3>Orders</h3>
    <div id="ordersTable"></div>
  </div>
  <div id="section-users" class="section" style="display:none;">
    <h3>Users</h3>
    <div id="usersTable"></div>
  </div>
</div>

<script>
  function showNotificationMessage(message, color='#4CAF50') {
  const notif = document.getElementById('notification');
  notif.innerHTML = `<div style="background-color:${color}; color:#fff; padding:10px; display:inline-block; border-radius:4px;">${message}</div>`;
  notif.style.display = 'block';

  // Hide after 3 seconds
  setTimeout(() => {
    notif.style.display = 'none';
  }, 3000);
}

let isSendingSMS = false;

/**
 * Show a temporary notification on the page
 * @param {string} text
 * @param {string} color
 */
function showNotificationMessage(text, color = '#333') {
  let box = document.getElementById('notificationMessage');

  if (!box) {
    box = document.createElement('div');
    box.id = 'notificationMessage';
    box.style.position = 'fixed';
    box.style.bottom = '20px';
    box.style.left = '50%';
    box.style.transform = 'translateX(-50%)';
    box.style.padding = '12px 20px';
    box.style.borderRadius = '8px';
    box.style.color = '#fff';
    box.style.fontSize = '14px';
    box.style.zIndex = '9999';
    document.body.appendChild(box);
  }

  box.style.backgroundColor = color;
  box.innerText = text;

  setTimeout(() => box.remove(), 4000);
}

// Function to trigger Twilio notification (assumes backend endpoint `/send-twilio`)
function sendTwilioNotification(phoneNumber, message) {
  fetch('/send-twilio', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ phoneNumber, message })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      showNotificationMessage('Notification sent successfully!', 'green');
    } else {
      showNotificationMessage('Failed to send notification.', 'red');
    }
  })
  .catch(() => {
    showNotificationMessage('Error sending notification.', 'red');
  });
}

/**
 * Send SMS via backend /notify/sms with retries & timeout
 * @param {string} to - Phone number (E.164 format)
 * @param {string} message - Message content
 * @param {function} [callback] - Optional callback on success
 * @param {number} [retries=2] - Number of retries on failure
 */
async function sendSms(to, message, callback = null, retries = 2) {
  if (!to || !message) {
    showNotificationMessage('Phone number or message missing', '#f44336');
    return;
  }

  if (isSendingSMS) {
    showNotificationMessage('Another message is sending...', '#ff9800');
    return;
  }

  isSendingSMS = true;
  showNotificationMessage('Sending message...', '#2196F3');

  const attemptSend = async (attempt = 1) => {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout

    try {
      const res = await fetch('/notify/sms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        signal: controller.signal,
        body: JSON.stringify({ to, message })
      });

      clearTimeout(timeout);
      const data = await res.json();

      if (!res.ok) throw new Error(data.error || 'Server error');

      showNotificationMessage('SMS sent successfully ✔️', '#4CAF50');
      console.log('SMS sent:', data);

      if (callback && typeof callback === 'function') callback(data);

    } catch (err) {
      clearTimeout(timeout);
      console.error(`SMS Error (Attempt ${attempt}):`, err);

      if (err.name === 'AbortError') {
        showNotificationMessage('Request timed out ⏱️', '#f44336');
      } else {
        showNotificationMessage('Failed to send SMS ❌', '#f44336');
      }

      if (attempt <= retries) {
        console.log(`Retrying... (${attempt + 1})`);
        return attemptSend(attempt + 1);
      }
    } finally {
      isSendingSMS = false;
    }
  };

  attemptSend();
}

/**
 * Optional: Send SMS to user by Supabase user ID
 * Requires Supabase client to be initialized
 */
async function sendSmsToUser(userId, message, callback = null) {
  try {
    const { data, error } = await supabase
      .from('User')
      .select('phone')
      .eq('id', userId)
      .single();

    if (error || !data?.phone) {
      showNotificationMessage('User phone not found', '#f44336');
      console.error('Supabase Error:', error);
      return;
    }

    sendSms(data.phone, message, callback);

  } catch (err) {
    console.error('Error fetching user phone:', err);
    showNotificationMessage('Error fetching user info', '#f44336');
  }
}

  // Initialize Supabase
  const supabaseUrl = 'https://wbpgmgtoyzlnawvsfeiu.supabase.co';
  const supabaseKey = process.env.SUPABASE_KEY; // Actual key
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  function toggleDropdown() {
    document.getElementById('profileDropdown').classList.toggle('show');
  }

  function showManagement(type) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    if (type==='items') { document.getElementById('section-items').style.display='block'; renderItems(); }
    if (type==='orders') { document.getElementById('section-orders').style.display='block'; renderOrders(); }
    if (type==='users') { document.getElementById('section-users').style.display='block'; renderUsers(); }
    if (type==='payment') { fetchPayments(); document.getElementById('section-payment').style.display='block'; }
  }

  function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(s => s.style.display='none');
    document.getElementById('section-' + sectionId).style.display='block';
  }
//Add twilio notification
  // Upload Menu
  async function uploadMenu() {
    const restaurantName = document.getElementById('restaurantName').value.trim();
    const fileInput = document.getElementById('menuFile');
    if (!restaurantName || !fileInput.files.length) {
      alert('Please enter restaurant name and select a PDF file.');
      return;
    }
    const file = fileInput.files[0];

    try {
      const filePath = `menus/${restaurantName}_${Date.now()}.pdf`;
      const { data, error } = await supabase.storage
        .from('menus')
        .upload(filePath, file);
      if (error) throw error;

      await supabase
        .from('restaurant_menus')
        .insert({ restaurant_name: restaurantName, file_path: filePath });
      alert('Menu uploaded successfully!');
    } catch (err) {
      console.error('Upload error:', err);
      alert('Error uploading menu: ' + err.message);
    }
  }

  // Save Restaurant Info
  async function saveRestaurantInfo() {
    const name = document.getElementById('restName').value.trim();
    const contact = document.getElementById('contact').value.trim();
    const website = document.getElementById('website').value.trim();
    const address = document.getElementById('address').value.trim();

    if (!name || !contact || !website || !address) {
      alert('Please fill in all fields.');
      return;
    }
    try {
      await supabase
        .from('restaurants')
        .insert({ name, contact, website, address });
      alert('Restaurant details saved!');
    } catch (err) {
      console.error('Error saving info:', err);
      alert('Error saving details: ' + err.message);
    }
  }

  // Add Item
  async function addItem() {
    const vendor = document.getElementById('itemVendor').value.trim();
    const itemName = document.getElementById('itemName').value.trim();
    const price = parseFloat(document.getElementById('itemPrice').value);
    const stockStatus = document.getElementById('itemStock').value;

    if (!vendor || !itemName || isNaN(price)) {
      alert('Please fill all fields correctly.');
      return;
    }
    try {
      await supabase
        .from('items')
        .insert({ vendor, item_name: itemName, price, stock_status: stockStatus });
      alert('Item added!');
      // Optionally refresh items list
      renderItems();
    } catch (err) {
      console.error('Add item error:', err);
      alert('Error adding item: ' + err.message);
    }
  }

  // Add Order
  async function addOrder() {
    const orderId = document.getElementById('orderId').value.trim();
    const userName = document.getElementById('orderUserName').value.trim();
    const userEmail = document.getElementById('orderUserEmail').value.trim();
    const method = document.getElementById('orderMethod').value.trim();
    const amount = parseFloat(document.getElementById('orderAmount').value);

    if (!orderId || !userName || !userEmail || !method || isNaN(amount)) {
      alert('Please fill all fields correctly.');
      return;
    }
    try {
      await supabase
        .from('orders')
        .insert({ order_id: orderId, user_name: userName, user_email: userEmail, payment_method: method, amount });
      alert('Order added!');
      // Optionally refresh orders list
      renderOrders();
    } catch (err) {
      console.error('Add order error:', err);
      alert('Error adding order: ' + err.message);
    }
  }

  // Add User
  async function addUser() {
    const email = document.getElementById('userEmail').value.trim();
    const name = document.getElementById('userName').value.trim();

    if (!email || !name) {
      alert('Please fill all fields.');
      return;
    }
    try {
      await supabase
        .from('users')
        .insert({ email, name });
      alert('User added!');
      // Optionally refresh users list
      renderUsers();
    } catch (err) {
      console.error('Add user error:', err);
      alert('Error adding user: ' + err.message);
    }
  }

  // Fetch and render Items
  async function renderItems() {
    const { data, error } = await supabase
      .from('items')
      .select('*');
    if (error) {
      document.getElementById('itemsTable').innerHTML = '<p>Error loading items.</p>';
      return;
    }
    if (data.length === 0) {
      document.getElementById('itemsTable').innerHTML = '<p>No items available.</p>';
      return;
    }
    let html = `<table>
      <thead>
        <tr><th>Vendor</th><th>Name</th><th>Price</th><th>Status</th></tr>
      </thead><tbody>`;
    data.forEach(item => {
      html += `<tr>
        <td>${item.vendor}</td>
        <td>${item.item_name}</td>
        <td>$${item.price.toFixed(2)}</td>
        <td>${item.stock_status}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('itemsTable').innerHTML = html;
  }

  // Fetch and render Orders
  async function renderOrders() {
    const { data, error } = await supabase
      .from('orders')
      .select('*');
    if (error) {
      document.getElementById('ordersTable').innerHTML = '<p>Error loading orders.</p>';
      return;
    }
    if (data.length === 0) {
      document.getElementById('ordersTable').innerHTML = '<p>No orders available.</p>';
      return;
    }
    let html = `<table>
      <thead>
        <tr><th>Order ID</th><th>User</th><th>Email</th><th>Method</th><th>Amount</th></tr>
      </thead><tbody>`;
    data.forEach(order => {
      html += `<tr>
        <td>${order.order_id}</td>
        <td>${order.user_name}</td>
        <td>${order.user_email}</td>
        <td>${order.payment_method}</td>
        <td>$${order.amount.toFixed(2)}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('ordersTable').innerHTML = html;
  }

  // Fetch and render Users
  async function renderUsers() {
    const { data, error } = await supabase
      .from('users')
      .select('*');
    if (error) {
      document.getElementById('usersTable').innerHTML = '<p>Error loading users.</p>';
      return;
    }
    if (data.length === 0) {
      document.getElementById('usersTable').innerHTML = '<p>No users available.</p>';
      return;
    }
    let html = `<table>
      <thead>
        <tr><th>Email</th><th>Name</th></tr>
      </thead><tbody>`;
    data.forEach(user => {
      html += `<tr>
        <td>${user.email}</td>
        <td>${user.name}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    document.getElementById('usersTable').innerHTML = html;
  }

  // Fetch Payments
  async function fetchPayments() {
    const { data, error } = await supabase
      .from('payment_history')
      .select('*')
      .order('payment_date', { ascending: false });
    if (error) {
      document.getElementById('paymentHistoryContainer').innerHTML = '<p>Error loading payment history.</p>';
      return;
    }
    if (data.length === 0) {
      document.getElementById('paymentHistoryContainer').innerHTML = '<p>No payment history available.</p>';
      return;
    }
    let html = `
      <table>
        <thead>
          <tr>
            <th>Payment ID</th>
            <th>Order ID</th>
            <th>User Name</th>
            <th>User Email</th>
            <th>Method</th>
            <th>Amount</th>
            <th>Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
    `;
    data.forEach(p => {
      html += `
        <tr>
          <td>${p.payment_id}</td>
          <td>${p.order_id}</td>
          <td>${p.user_name}</td>
          <td>${p.user_email}</td>
          <td>${p.payment_method}</td>
          <td>$${p.amount.toFixed(2)}</td>
          <td>${new Date(p.payment_date).toLocaleString()}</td>
          <td>${p.status}</td>
        </tr>
      `;
    });
    html += `</tbody></table>`;
    document.getElementById('paymentHistoryContainer').innerHTML = html;
     const payfast = require('@payfast/core');
// Your actual merchant_id and passphrase
const merchantId = "10004002";
const passphrase = "payfast";

// Example: Get weekly history (adjust date as needed)
async function getdailyHistory() {
  try {
    const response = await payfast.transactions.daily({
      "date": "2025-01-15",
      "version": "v1",
      "timestamp": new Date().toISOString(),
      "passphrase": passphrase,
      "merchant-id": merchantId
    });
    console.log(response); // Process the returned data (often CSV/JSON)
  } catch (error) {
    console.error("Error fetching history:", error);
  }
}

getDailyHistory();
  }

  // Initialize default view
  window.onload = () => {
    showManagement('items');
  };
</script>
</body>
</html>