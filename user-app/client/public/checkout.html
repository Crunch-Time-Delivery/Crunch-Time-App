<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout & Tracking</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  /* Checkout styles */
  #checkoutPage {
    padding: 20px;
    background: #fff;
    max-width: 600px;
    margin: auto;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  #checkoutPage h2, #checkoutPage h3 {
    margin-top: 0;
  }
  #checkoutItems {
    list-style: none;
    padding: 0;
  }
  #checkoutItems li {
    margin-bottom: 8px;
  }
  #payNowButton {
    background-color: red;
    color: #fff;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    width: 100%;
    margin-top: 20px;
  }
  /* Modal styles for payment */
  .modal {
    display: none;
    position: fixed;
    z-index: 999;
    left:0; top:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
  }
  .popup-content {
    background:#fff; padding:20px; border-radius:10px; max-width:400px; width:90%;
  }
  /* Tracking styles */
  #trackingContainer {
    display: none;
    padding: 10px;
  }
  #map { width: 100%; height: 70vh; }
  #orderInfo { padding: 10px; background: #eee; text-align: center; }
  /* Notification */
  #notification {
    display:none; position:fixed; top:20px; width:100%; z-index:9999; text-align:center;
  }
</style>
</head>
<body>

<!-- Checkout Page -->
<div id="checkoutPage">
  <h2>Checkout</h2>
  <h3>Order Summary</h3>
  <ul id="checkoutItems"></ul>
  <h3>Total: <span id="totalAmount">R0</span></h3>
  <button id="payNowButton" onclick="showPaymentMethodPage()">Pay</button>
</div>

<!-- Payment modal -->
<div id="paymentPopup" class="modal">
  <div class="popup-content">
    <h3>Select Payment Method</h3>
    <div class="payment-options">
      <div class="payment-option" onclick="selectPaymentMethod('Card')">
        <div class="payment-icons">
          <img src="https://img.icons8.com/color/48/000000/visa.png" alt="Visa" />
          <img src="https://img.icons8.com/color/48/000000/mastercard-logo.png" alt="MasterCard" />
          <img src="https://img.icons8.com/color/48/000000/amex.png" alt="Amex" />
        </div>
        <span style="margin-left:10px;">Pay by Card</span>
      </div>
      <div class="payment-option" onclick="selectPaymentMethod('EFT')">
        <strong>EFT Bank Transfer</strong>
      </div>
    </div>
    <div id="eftDetails" style="display:none; margin-top:15px;">
      <h4>Banking Details</h4>
      <p>Bank: ABC Bank</p>
      <p>Account Number: 123456789</p>
      <p>Branch Code: 000123</p>
      <p>Account Name: CrunchTime</p>
      <button style="margin-top:10px; padding:8px 12px; background:#ff0000; color:#fff; border:none; border-radius:4px; cursor:pointer;" onclick="openBankDetailsInput()">Enter/Edit Banking Details</button>
    </div>
    <div class="popup-buttons" style="margin-top:20px;">
      <button onclick="finalizePayment()">Pay Now</button>
      <button onclick="closePaymentPopup()">Cancel</button>
    </div>
  </div>
</div>

<!-- Voucher registration form -->
<div class="form-popup" id="myForm">
  <form class="form-container" onsubmit="return false;">
    <h2>Voucher Registration</h2>
    <p>Enter your email to receive a code:</p>
    <input type="email" id="email" placeholder="Email" required />
    <button type="button" onclick="submitVoucher()">Get Code</button>
    <button type="button" onclick="closeForm()">Close</button>
  </form>
</div>

<!-- Bank details input -->
<div id="bankDetailsInput" class="modal">
  <div class="popup-content" style="max-width:400px;">
    <span onclick="closeBankDetails()" style="cursor:pointer; float:right;">&times;</span>
    <h3>Enter Banking Details</h3>
    <form id="bankDetailsForm">
      <label>Bank Name:</label>
      <input type="text" id="bankName" style="width:100%; padding:8px;" />
      <label>Account Number:</label>
      <input type="text" id="accountNumber" style="width:100%; padding:8px;" />
      <label>Branch Code:</label>
      <input type="text" id="branchCode" style="width:100%; padding:8px;" />
      <label>Account Name:</label>
      <input type="text" id="accountName" style="width:100%; padding:8px;" />
      <button type="button" onclick="saveBankDetails()">Save Details</button>
    </form>
  </div>
</div>

<!-- Notification -->
<div id="notification"></div>

<!-- Tracking Container -->
<div id="trackingContainer">
  <div id="orderInfo">Loading order info...</div>
  <div id="map"></div>
</div>

<script>
  // Utility: show notification
  function showNotification(msg, color='#4CAF50') {
    const n = document.getElementById('notification');
    n.innerHTML = `<div style="background:${color}; color:#fff; padding:10px; border-radius:4px;">${msg}</div>`;
    n.style.display='block';
    setTimeout(()=>{n.style.display='none';}, 3000);
  }

  // Generate unique order ID
  function generateOrderId() {
    const t = Date.now();
    const rand = Math.floor(Math.random()*1000000);
    return `ORDER${t}${rand}`;
  }

  // Checkout summary
  const orderItems = [
    {name:'Sample Food 1', quantity:2, price:'R50'},
    {name:'Sample Food 2', quantity:1, price:'R30'}
  ];
  function populateOrder() {
    const ul = document.getElementById('checkoutItems');
    ul.innerHTML='';
    let total=0;
    orderItems.forEach(i=>{
      const li=document.createElement('li');
      li.innerHTML=`${i.name} x${i.quantity} @ ${i.price}`;
      ul.appendChild(li);
      total+=parseFloat(i.price.slice(1))*i.quantity;
    });
    document.getElementById('totalAmount').innerText=`R${total.toFixed(2)}`;
  }
  populateOrder();

  // Show payment modal
  function showPaymentMethodPage() {
    if (orderItems.length===0) { alert('Cart empty'); return; }
    document.getElementById('paymentPopup').style.display='flex';
  }
  function closePaymentPopup() {
    document.getElementById('paymentPopup').style.display='none';
  }
  let selectedPaymentMethod=null;
  function selectPaymentMethod(method) {
    selectedPaymentMethod=method;
    document.getElementById('eftDetails').style.display=(method==='EFT')?'block':'none';
  }

  // Finalize payment
  function finalizePayment() {
    if (!selectedPaymentMethod) { alert('Select payment'); return; }
    alert('Processing payment...');
    const newOrderId=generateOrderId();
    showNotification('Payment successful!');
    // Redirect after 2 sec
    setTimeout(()=>{
      window.location.href='?tracking&order='+encodeURIComponent(newOrderId);
    },2000);
  }

  // Detect if URL has 'tracking' param, show map
  const urlParams=new URLSearchParams(window.location.search);
  const isTracking= urlParams.has('tracking') && urlParams.get('order');

  if (isTracking) {
    document.getElementById('checkoutPage').style.display='none';
    document.getElementById('trackingContainer').style.display='block';

    const orderId=urlParams.get('order');

    document.getElementById('orderInfo').innerText='Tracking Order: '+orderId;

    // Load Google Maps
    function initMap() {
      let centerCoords;
      if (orderId==='ORDER1234567890') {
        centerCoords={lat:-33.9249, lng:18.4241}; // Cape Town
      } else {
        centerCoords={lat:0, lng:0};
      }
      const map=new google.maps.Map(document.getElementById('map'),{
        zoom:14,
        center:centerCoords,
        mapTypeId:'roadmap'
      });
      const driverMarker=new google.maps.Marker({
        map:map,
        position:centerCoords,
        title:'Driver',
        icon:{
          path:google.maps.SymbolPath.CIRCLE,
          scale:11,
          fillColor:'#d32f2f',
          fillOpacity:1,
          strokeColor:'#fff',
          strokeWeight:3
        }
      });
      if (orderId==='ORDER1234567890') {
        let angle=0;
        setInterval(()=>{
          angle+=10;
          const radius=0.01;
          const rad=angle*Math.PI/180;
          const lat=centerCoords.lat+Math.cos(rad)*radius;
          const lng=centerCoords.lng+Math.sin(rad)*radius;
          driverMarker.setPosition({lat,lng});
          map.panTo({lat,lng});
        },2000);
      }
    }
    // Load Google Maps script
    (function loadScript() {
      const s=document.createElement('script');
      s.src='https://maps.googleapis.com/maps/api/js?key=AIzaSyB9sNhi824hNncjfW7HHzaI_s8JtWGfM0Q&callback=initMap';
      s.async=true;
      document.head.appendChild(s);
    })();
  }

  // When user clicks pay
  document.getElementById('payNowButton').addEventListener('click', ()=> {
    showPaymentMethodPage();
  });
  // For demo: clicking "Pay" button in modal
  function finalizePayment() {
    alert('Processing payment...');
    const newOrderId=generateOrderId();
    showNotification('Payment successful!');
    setTimeout(()=>{
      window.location.href='?tracking&order='+encodeURIComponent(newOrderId);
    },2000);
  }

  // Placeholder functions for voucher etc.
  function submitVoucher() { alert('Voucher code sent!'); closeForm(); }
  function openForm() { document.getElementById("myForm").style.display = "flex"; }
  function closeForm() { document.getElementById("myForm").style.display = "none"; }
  function saveBankDetails() { alert('Bank details saved!'); closeBankDetails(); }
  function openBankDetailsInput() { document.getElementById('bankDetailsInput').style.display='flex'; }
  function closeBankDetails() { document.getElementById('bankDetailsInput').style.display='none'; }

</script>
</body>
</html>