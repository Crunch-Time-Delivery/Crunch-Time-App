<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout</title>

<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
.hidden{display:none}
.container{max-width:420px;margin:auto;padding-bottom:90px}
.header{background:#fff;padding:15px;font-weight:bold;text-align:center}
.map img{width:100%;height:200px;object-fit:cover}
.card,.tips{background:#fff;margin:12px;padding:14px;border-radius:14px}
.address{display:flex;justify-content:space-between;align-items:center}
.voucher{background:#ffb84d;padding:14px;margin:12px;border-radius:10px;text-align:center;font-weight:bold;color:#fff;cursor:pointer}

.summary-row{display:flex;justify-content:space-between;margin-bottom:6px}
.total-row{border-top:1px dashed #ddd;padding-top:8px;font-weight:bold;font-size:16px}

.method{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #eee}
.method-left{display:flex;align-items:center;gap:10px}
.method img{width:32px}

.bottom-bar{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:420px;background:red;color:#fff;
  padding:16px;display:flex;justify-content:space-between;
  font-weight:bold;cursor:pointer
}

/* Tips */
.tip-options{display:flex;gap:10px;margin-top:10px}
.tip-btn{
  flex:1;padding:10px;border-radius:10px;
  border:1px solid #ddd;background:#fff;
  cursor:pointer;font-weight:bold
}
.tip-btn.active{background:red;color:#fff;border-color:red}

/* Popup */
.popup-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  display:none;align-items:center;justify-content:center;z-index:1000
}
.popup{
  background:#fff;padding:16px;width:280px;border-radius:12px
}
.popup input,.popup button{
  width:100%;padding:10px;margin-top:10px
}
</style>
</head>

<body>

<div class="container">
<div class="header">Checkout</div>

<!-- MAP -->
<div class="map">
<img id="staticMap" src="" alt="Delivery Map">
</div>

<!-- ADDRESS -->
<div class="card address">
  <div>
    <strong id="deliveryAddress">Loading address...</strong><br>
    <small>Delivery 25 ‚Äì 35 min</small>
  </div>
  ‚úèÔ∏è
</div>

<div class="voucher" onclick="openVoucher()">Input voucher coupon</div>

<!-- Tips -->
<div class="tips">
<strong>Add a tip for your driver</strong>
<div class="tip-options">
<button class="tip-btn" onclick="setTip(5,this)">R5</button>
<button class="tip-btn" onclick="setTip(10,this)">R10</button>
<button class="tip-btn" onclick="setTip(15,this)">R15</button>
</div>
</div>

<!-- SUMMARY -->
<div class="card">
<div class="summary-row"><span>Subtotal</span><span id="subtotal">R0.00</span></div>
<div class="summary-row"><span>Delivery Discount</span><span id="discount">R0.00</span></div>
<div class="summary-row"><span>Service Fee</span><span>R10.00</span></div>
<div class="summary-row"><span>Delivery Fee</span><span>R20.00</span></div>
<div class="summary-row"><span>Tip</span><span id="tipAmount">R0.00</span></div>
<div class="summary-row total-row"><span>Total</span><span id="total">R0.00</span></div>
</div>


<!-- PAYMENT METHODS + PAYFAST FORM -->
<form id="payfastForm" method="POST" action="https://sandbox.payfast.co.za/eng/process">
  <!-- PayFast hidden fields -->
  <input type="hidden" name="merchant_id" value="10000100">
  <input type="hidden" name="merchant_key" value="46f0cd694581a">
  <input type="hidden" name="amount" id="pf_amount">
  <input type="hidden" name="item_name" value="CrunchTime Order">
  <input type="hidden" name="item_description" value="Food delivery checkout">
  <input type="hidden" name="payment_method" id="pf_method">
  <input type="hidden" name="signature" id="pf_signature"> <!-- hash signature -->
  <input type="hidden" name="return_url" value="http://127.0.0.1:5501/user-app/client/public/checkout_order.html">
  <input type="hidden" name="cancel_url" value="http://127.0.0.1:5501/user-app/client/public/index.html">
  <input type="hidden" name="notify_url" value="https://example.com/notify">

  <div class="card">
    <!-- Instant EFT -->
    <div class="method">
      <div class="method-left">
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png">
        Instant EFT (Company Account)
      </div>
      <input type="radio" name="paymethod" value="eft" checked onchange="toggleCardForm(false)">
      <div style="font-size:12px;color:#555;margin-top:5px;">
        Bank: ABSA, Account Name: CrunchTime, Acc #: 1234567890
      </div>
    </div>

    <!-- Card Payment -->
    <div class="method">
      <div class="method-left">
        <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png">
        Card Payment (Visa / MasterCard / Amex)
      </div>
      <input type="radio" name="paymethod" value="cc" onchange="toggleCardForm(true)">
    </div>

    <!-- Card Input Form -->
    <div class="card hidden" id="cardForm">
      <strong>Enter Card Details</strong>
      <input type="text" name="card_number" placeholder="Card Number" maxlength="19" oninput="formatCardNumber(this)" required />
      <input type="text" name="card_name" placeholder="Cardholder Name" required />
      <div style="display:flex;gap:10px">
        <input type="text" name="card_expiry" placeholder="MM/YY" maxlength="5" required />
        <input type="password" name="card_cvv" placeholder="CVV" maxlength="4" required />
      </div>
      <small style="color:#777">üîí Secure payment processed by PayFast</small>
      <button type="button" onclick="submitCardForm()" style="margin-top:10px;background:red;color:#fff;padding:10px;border:none;width:100%;border-radius:6px;cursor:pointer;">
        Submit Card & Pay
      </button>
    </div>
  </div>
</form>


<div class="bottom-bar" onclick="payNow()">
<span>Place Order</span>
<span id="barTotal">R0.00</span>
</div>

<!-- Voucher Popup -->
<div class="popup-overlay" id="voucherPopup">
<div class="popup">
<strong>Enter Voucher Code</strong>
<input id="voucherCode" placeholder="SAVE20">
<button onclick="applyVoucher()">Apply</button>
</div>
</div>

<script>
/* ================= CARD FORM TOGGLE ================= */
function toggleCardForm(show) {
  document.getElementById("cardForm").classList.toggle("hidden", !show);
}

/* ================= CARD NUMBER FORMAT ================= */
function formatCardNumber(input) {
  input.value = input.value.replace(/\D/g, "").replace(/(.{4})/g, "$1 ").trim();
}

/* ================= CALCULATE HASH ================= */
function generateHash(fields, merchantKey) {
  // Concatenate the fields in PayFast recommended order: key=value&key=value...
  let str = Object.keys(fields)
    .filter(k => fields[k] !== undefined && fields[k] !== "")
    .sort()
    .map(k => `${k}=${fields[k]}`)
    .join("&");

  // Append merchant key at the end
  str += `&merchant_key=${merchantKey}`;

  // Simple JS hash (SHA-256) using crypto API
  return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str))
    .then(buf => {
      // convert ArrayBuffer to hex string
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
    });
}

/* ================= PAYFLOW ================= */
function payNow() {
  const selectedMethod = document.querySelector('input[name="paymethod"]:checked').value;
  document.getElementById("pf_method").value = selectedMethod;

  if (selectedMethod === "cc") {
    // Show card form first
    toggleCardForm(true);
    return; // stop auto-submit until user enters card details
  }

  // EFT can submit directly
  generateAndSubmitHash(selectedMethod);
}

function submitCardForm() {
  const selectedMethod = "cc";
  document.getElementById("pf_method").value = selectedMethod;
  document.getElementById("cardForm").classList.add("hidden");

  generateAndSubmitHash(selectedMethod);
}

/* ================= GENERATE HASH AND SUBMIT ================= */
function generateAndSubmitHash(paymentMethod) {
  const pfAmount = document.getElementById("pf_amount").value;
  const merchantKey = document.querySelector('input[name="merchant_key"]').value;

  const fields = {
    amount: pfAmount,
    item_name: "CrunchTime Order",
    item_description: "Food delivery checkout",
    payment_method: paymentMethod
  };

  generateHash(fields, merchantKey).then(hash => {
    document.getElementById("pf_signature").value = hash;
    document.getElementById("payfastForm").submit();
  });
}

/* ================= LOCATION ================= */
document.getElementById("deliveryAddress").innerText =
  localStorage.getItem("deliveryAddress") || "17 Bishop Park Way";

/* ================= CHECKOUT ================= */
let subtotal = 170;
let discount = 0;
let tip = 0;
const serviceFee = 10;
const deliveryFee = 20;

function recalc(){
  const total = subtotal - discount + serviceFee + deliveryFee + tip;
  document.getElementById("subtotal").innerText = "R" + subtotal.toFixed(2);
  document.getElementById("discount").innerText = "-R" + discount.toFixed(2);
  document.getElementById("tipAmount").innerText = "R" + tip.toFixed(2);
  document.getElementById("total").innerText = "R" + total.toFixed(2);
  document.getElementById("barTotal").innerText = "R" + total.toFixed(2);
  document.getElementById("pf_amount").value = total.toFixed(2);
}

function setTip(amount, btn){
  tip = amount;
  document.querySelectorAll(".tip-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  recalc();
}

function openVoucher(){
  document.getElementById("voucherPopup").style.display="flex";
}

function applyVoucher(){
  if(document.getElementById("voucherCode").value.toUpperCase()==="SAVE20"){
    discount = 20;
  }
  document.getElementById("voucherPopup").style.display="none";
  recalc();
}

/* ================= PAYFLOW ================= */
function payNow(){
  recalc();
  const selectedMethod = document.querySelector('input[name="paymethod"]:checked').value;
  if(selectedMethod === 'cc'){
    // show card form popup first
    toggleCardForm(true);
    return; // stop auto-submit
  }
  document.getElementById("pf_method").value = selectedMethod;
  document.getElementById("payfastForm").submit();
}

function submitCardForm(){
  const selectedMethod = 'cc';
  document.getElementById("pf_method").value = selectedMethod;
  document.getElementById("cardForm").classList.add("hidden");
  document.getElementById("payfastForm").submit();
}

/* INIT */
recalc();
</script>

</body>
</html>
