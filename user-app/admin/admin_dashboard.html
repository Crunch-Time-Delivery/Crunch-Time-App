<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard</title>
<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding-top:70px;
  }

  /* Top header with CRUNCHTIME */
  .top-header { /* unchanged */ }
  /* Fixed Header styles */
  .header { /* unchanged */ }
  /* Menu container styles */
  .menu-container { /* unchanged */ }
  #menuDropdown { /* unchanged */ }
  #menuDropdown button { /* unchanged */ }
  /* Profile section styles */
  .profile-section { /* unchanged */ }
  #profileImage { /* unchanged */ }
  .admin-name { /* unchanged */ }
  /* Sections hidden/shown */
  .section { display:none; padding-top:70px; }
  .section.active { display:block; }
  /* Buttons styling */
  button { /* unchanged */ }
  .btn-primary { /* unchanged */ }
  /* Modal overlays for login, admin update, role view */
  .modal { /* unchanged */ }
  .modal-box { /* unchanged */ }
  /* Additional styling for dashboard elements */
  h2 { margin-bottom:10px; }
  /* Filter dropdown style */
  #filterDropdown { /* unchanged */ }
  #filterDropdown button { /* unchanged */ }
  /* Chart container styles */
  .chart-container { display: flex; flex-direction: column; align-items: center; margin-top: 20px; }
  canvas { max-width: 400px; margin: 20px 0; }
  /* Role Buttons */
  .role-buttons { display: flex; gap: 10px; }
  /* Style for percentage change texts */
  .percentage-change { font-size: 14px; margin-left: 10px; }
  /* Fix for Popular Food label positioning */
  .popular-food {
    margin-top: 30px;
    padding: 10px;
  }
  .food-header {
    font-size: 20px; font-weight: bold; margin-bottom: 5px; display:flex; align-items:center; justify-content:space-between;
  }
  /* Adjust circle graph container for label placement */
  .circle-label-container {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 0 auto;
  }
  .circle-percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px; font-weight: bold;
  }
</style>
</head>
<body>

<!-- ================== LOGIN MODAL ================== -->
<div id="loginModal" class="modal" style="display:flex;">
  <div class="modal-box">
    <div class="modal-content" style="max-width: 300px; padding:20px; text-align:center; display:flex; flex-direction:column; align-items:center;">
      <img src="Screenshot (254).jpg" alt="Welcome Image" style="width:250px; height:auto; margin-bottom:20px;">
      <h2 style="color:gray;">Welcome</h2>
      <h3>Admin Login</h3>
      <label>Username</label>
      <input type="text" id="username" placeholder="Username" style="width:100%; margin-bottom:10px; padding:8px;"/>
      <label>Password</label>
      <input type="password" id="password" placeholder="Password" style="width:100%; margin-bottom:10px; padding:8px;"/>
      <button  style="width:100%;background-color:red" onclick="verifyLogin()">Login</button>
    </div>
  </div>
</div>

<!-- ================== Admin Credential Popup ================== -->
<div id="adminPopup" class="modal" style="display:none;">
  <div class="modal-box" style="width:400px;">
     <img src="Screenshot (254).jpg" alt="Welcome Image" style="width:250px; height:auto; margin-bottom:20px;">
    <h3>Admin Update</h3>
    <div>
      <label>Change Username:</label>
      <input type="text" id="newUsername" style="width:100%; margin-bottom:10px;"/>
    </div>
    <div>
      <label>Change Password:</label>
      <input type="password" id="newPassword" style="width:100%; margin-bottom:10px;"/>
    </div>
    <button onclick="saveAdminCredentials()">Save Credentials</button>
    <hr style="margin:10px 0;"/>
    <h4>Add New Admin</h4>
    <div>
      <label>Email:</label>
      <input type="email" id="newAdminEmail" style="width:100%; margin-bottom:10px;"/>
    </div>
    <div>
      <label>Username:</label>
      <input type="text" id="newAdminUsername" style="width:100%; margin-bottom:10px;"/>
    </div>
    <div>
      <label>Password:</label>
      <input type="password" id="newAdminPassword" style="width:100%; margin-bottom:10px;"/>
    </div>
    <button onclick="addNewAdmin()">Add Admin</button>
    <button style="margin-top:10px; background:red; color:#fff; width:100%;" onclick="closeAdminPopup()">Close</button>
  </div>
</div>

<!-- ================== HEADER with Menu & Profile ================== -->
<div class="header">
  <!-- Menu Dropdown -->
  <div class="menu-container">
    <div class="menu-icon" title="Menu" style="cursor:pointer; font-size:24px;" onclick="toggleMenuDropdown()">â˜°</div>
    <div id="menuDropdown">
      <button onclick="showSection('dashboard')">Dashboard</button>
      <button onclick="window.location.href='http://127.0.0.1:5501/driver-app/admin/estabilshment.html '">Establishment</button>
      <button onclick="window.location.href='http://127.0.0.1:5501/driver-app/admin/restaurant_menu.html  '">Restaurant Menu</button>
      <button onclick="showSection('Driver')">Driver</button>
      <button onclick="showSection('Vendor')">Vendor</button>
    </div>
  </div>
  <!-- Profile Section -->
  <div class="profile-section" style="display:flex; align-items:center; cursor:pointer;" onclick="triggerProfileImageUpload()">
    <img src="https://via.placeholder.com/40" id="profileImage" alt="Profile" />
    <input type="file" id="profileImageInput" accept="image/*" style="display:none;" onchange="updateProfileImage(event)">
    <div class="admin-name" id="adminName">Admin</div>
  </div>
</div>

<!-- ================== DASHBOARD ================== -->
<div id="dashboard" class="section active">
  <!-- Dashboard content -->
  <!-- Your existing dashboard code for summary, charts, etc. -->
  <!-- Insert the dashboard details from your previous code here: -->
  <!-- For brevity, I'll just include the main dashboard info below -->
  <!-- The dashboard code begins: -->
  <div>
    <div class="top-bar" style="margin-top:0;">
      <div class="profile-section">
        <div class="profile-picture"></div>
        <div class="admin-name">Admin Dashboard</div>
      </div>
      <div class="menu-icon" title="Menu">â˜°</div>
    </div>
    <div class="dashboard-container">
      <!-- Filters & Income -->
      <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 20px 0 20px;">
        <div style="position:relative;">
          <button onclick="toggleFilterDropdown()">Filter Establishments â–¼</button>
          <div id="filterDropdown">
            <button onclick="filterEstablishments('All')">All</button>
            <button onclick="filterEstablishments('Type 1')">Type 1</button>
            <button onclick="filterEstablishments('Type 2')">Type 2</button>
          </div>
        </div>
        <div style="display:flex; gap:10px;">
          <button style="background-color:red; color:#fff;">Total Income</button>
          <button style="background-color:red; color:#fff;">Income</button>
          <button style="background-color:red; color:#fff;">Expense</button>
          <button style="background-color:red; color:#fff;">Withdraw</button>
        </div>
      </div>
      <!-- Total Income and Amounts for Income, Expense, Withdraw with % -->
      <div style="margin-top:20px; padding-left:20px;">
        <h2>Total Income: <span id="incomeAmount">R10,000</span>
          <span class="percentage-change" id="incomePerc"></span>
        </h2>
        <h2>Expense: <span id="expenseAmount">R5,000</span>
          <span class="percentage-change" id="expensePerc"></span>
        </h2>
        <h2>Withdraw: <span id="withdrawAmount">R2,000</span>
          <span class="percentage-change" id="withdrawPerc"></span>
        </h2>
      </div>
      
      <!-- Performance Section -->
      <div class="performance-section" style="margin-top:20px; padding:0 20px;">
        <div class="performance-header" style="display:flex; justify-content:space-between; align-items:center;">
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="performance-title" style="font-size:20px;font-weight:bold;">Performance</div>
            <div class="performance-icon" title="Performance" style="font-size:24px;">ðŸ“ˆ</div>
          </div>
          <div style="margin-top:10px; font-size:24px;">ðŸ“ˆ</div>
        </div>
        <div style="display:flex; flex-direction:column; align-items:center; margin-top:20px;">
          <!-- Circle Graph Container with label closer -->
          <div class="circle-label-container">
            <canvas id="circleChart" width="200" height="200"></canvas>
            <div class="circle-percentage" id="circlePercentage">70%</div>
          </div>
          <!-- Year Dropdown -->
          <div class="year-dropdown" style="position:relative;">
            <button class="year-button" onclick="toggleYearDropdown()">January â–¼</button>
            <div class="year-options" id="yearOptions" style="display:none; position:absolute; top:100%; right:0; background:#fff; border:1px solid #ccc; flex-direction:column; z-index:10;">
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('January')">January</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('February')">February</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('March')">March</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('April')">April</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('May')">May</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('June')">June</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('July')">July</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('August')">August</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('September')">September</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('October')">October</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('November')">November</div>
              <div style="padding:8px; cursor:pointer;" onclick="selectMonth('December')">December</div>
            </div>
          </div>
        </div>
        <!-- Order Total & Target Boxes -->
        <div class="boxes-container" style="display:flex; gap:20px; margin-top:20px;">
          <!-- Order Total -->
          <div class="box" style="background:#fff; padding:15px; flex:1; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <div class="box-header" style="display:flex; align-items:center; margin-bottom:10px;">
              <div class="profile-icon" style="width:30px; height:30px; border-radius:50%; background:#ccc; margin-right:10px;"></div>
              <div class="box-title" style="font-weight:bold;">Order Total</div>
            </div>
            <div class="box-amount" style="font-size:20px;">R5000</div>
          </div>
          <!-- Target -->
          <div class="box" style="background:#fff; padding:15px; flex:1; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
            <div class="box-header" style="display:flex; align-items:center; margin-bottom:10px;">
              <div class="profile-icon" style="width:30px; height:30px; border-radius:50%; background:#ccc; margin-right:10px;"></div>
              <div class="box-title" style="font-weight:bold;">Target</div>
            </div>
            <div class="target-container" style="margin-top:10px;">
              <div class="linear-bar" style="height:10px; background:#ddd; border-radius:5px; overflow:hidden;">
                <div class="target-progress" style="width:75%; height:10px; background:#4caf50;"></div>
              </div>
              <div style="margin-top:10px;">Target: 75%</div>
            </div>
          </div>
        </div>
        <!-- Last Month & Last Year -->
        <div class="selection-row" style="display:flex; gap:20px; margin-top:20px;">
          <!-- One This Month -->
          <div class="select-box" style="flex:1;">
            <div class="select-header" style="display:flex; justify-content:space-between; align-items:center;">
              <h4>One This Month</h4>
              <div class="option-icon" title="Options" style="width:30px; height:30px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">â‹®</div>
            </div>
            <div>Number: 80</div>
            <div class="wave-graph" style="height:50px; background:#e0e0e0; margin-top:10px; border-radius:4px; display:flex; align-items:center; justify-content:center;">Wave Graph</div>
            <canvas id="waveGraphThisMonth" width="400" height="200"></canvas>
          </div>
          <!-- Last Year -->
          <div class="select-box" style="flex:1;">
            <div class="select-header" style="display:flex; justify-content:space-between; align-items: center;">
              <h4>One Last</h4>
              <div class="option-icon" title="Options" style="width:30px; height:30px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">â‹®</div>
            </div>
            <div>Number: 70</div>
            <div class="wave-graph" style="height:50px; background:#e0e0e0; margin-top:10px; border-radius:4px; display:flex; align-items:center; justify-content:center;">Wave Graph</div>
            <canvas id="waveGraphLastYear" width="400" height="200"></canvas>
          </div>
        </div>
        <!-- Additional info rows -->
        <div style="margin-top:30px; display:flex; flex-direction:column; gap:15px; padding:0 20px;">
          <!-- static info blocks omitted for brevity -->
        </div>
        <!-- Popular Food Chart -->
        <div class="popular-food" style="margin-top:30px;">
          <div class="food-header" style="font-size:20px; font-weight:bold; margin-bottom:5px;">
            <span>Popular Food</span>
          </div>
          <div class="chart-container" style="display:flex; justify-content:center; position:relative;">
            <canvas id="circleChart" width="400" height="400"></canvas>
            <!-- Closer label -->
            <div class="circle-percentage" id="circlePercentage">70%</div>
          </div>
          <div class="food-types" style="display:flex; flex-wrap:wrap; gap:15px; margin-top:10px">
            <!-- food items remain same -->
            <div class="food-item" style="display:flex; align-items:center; gap:10px;">
              <div class="food-color" style="width:20px; height:20px; border-radius:50%; background:#FF6384;"></div>
              <div>Fast Food - 40%</div>
            </div>
            <div class="food-item" style="display:flex; align-items:center; gap:10px;">
              <div class="food-color" style="width:20px; height:20px; border-radius:50%; background:#36A2EB;"></div>
              <div>Asian - 20%</div>
            </div>
            <div class="food-item" style="display:flex; align-items:center; gap:10px;">
              <div class="food-color" style="width:20px; height:20px; border-radius:50%; background:#FFCE56;"></div>
              <div>Pasta - 15%</div>
            </div>
            <div class="food-item" style="display:flex; align-items:center; gap:10px;">
              <div class="food-color" style="width:20px; height:20px; border-radius:50%; background:#4BC0C0;"></div>
              <div>Mexican - 10%</div>
            </div>
            <div class="food-item" style="display:flex; align-items:center; gap:10px;">
              <div class="food-color" style="width:20px; height:20px; border-radius:50%; background:#9966FF;"></div>
              <div>Turkish - 5%</div>
            </div>
            <div class="food-item" style="display:flex; align-items:center; gap:10px;">
              <div class="food-color" style="width:20px; height:20px; border-radius:50%; background:#FF9F40;"></div>
              <div>Desserts - 10%</div>
            </div>
          </div>
        </div>
      </div>
      <!-- View Role Button and Role Popup omitted for brevity -->
    </div>
  </div>
</div>

<!-- ================== Driver Section ================== -->
<div id="Driver" class="section" style="display:none; padding-top:70px;">
  <!-- Driver info omitted for brevity -->
</div>

<!-- ================== Vendor Section ================== -->
<div id="Vendor" class="section" style="display:none; padding-top:70px;">
  <h2 style="margin-left:20px;">Vendor Management</h2>
  <div style="padding:20px;">
    <button onclick="showVendors()">Show All Vendors</button>
  </div>
</div>

<!-- ================== Role Info Popup ================== -->
<div id="roleInfoPopup" class="modal" style="display:none;">
  <!-- popup content omitted for brevity -->
</div>

<!-- ================== Scripts ================== -->
<script src="supabaseClient.js" async></script> 
<script>
  // ================== INITIAL VARIABLES ==================
  let adminUsername = 'crunchtimeadmin';
  let adminPassword = 'crunchtimeadmin';

  let isAuthenticated = false;

  // ================== Notification Function (unchanged) ==================
  function showNotificationMessage(message, color='#4CAF50') {
    const notif = document.getElementById('notification') || (() => {
      const container = document.createElement('div');
      container.id='notification';
      container.style.position='fixed';
      container.style.bottom='20px';
      container.style.left='50%';
      container.style.transform='translateX(-50%)';
      container.style.padding='10px 20px';
      container.style.borderRadius='4px';
      container.style.backgroundColor=color;
      container.style.color='#fff';
      container.style.fontSize='14px';
      container.style.zIndex='9999';
      document.body.appendChild(container);
      return container;
    })();
    notif.innerHTML=`<div style="background-color:${color}; color:#fff; padding:10px; border-radius:4px;">${message}</div>`;
    notif.style.display='block';
    setTimeout(()=>{ notif.style.display='none'; },3000);
  }

  // ================== send SMS (unchanged) ==================
  function sendTwilioNotification(to, message) { /* same as above */ }

  // ================== Login & Auth (unchanged) ==================
  function verifyLogin() { /* unchanged */ }

  function showSection(id) { /* unchanged */ }

  // ================== Menu & Profile (unchanged) ==================
  function toggleMenuDropdown() { /* unchanged */ }
  document.addEventListener('click', e => { /* unchanged */ });
  function triggerProfileImageUpload() { /* unchanged */ }
  function updateProfileImage(e) { /* unchanged */ }

  // ================== Admin Credential Functions (unchanged) ==================
  function showAdminPopup() { /* unchanged */ }
  function closeAdminPopup() { /* unchanged */ }
  function saveAdminCredentials() { /* unchanged */ }

  // ================== Add New Admin (unchanged) ==================
  function addNewAdmin() { /* unchanged */ }

  // ================== Filter & Dropdowns (unchanged) ==================
  function toggleFilterDropdown() { /* unchanged */ }
  function filterEstablishments(type) { /* unchanged */ }
  function toggleYearDropdown() { /* unchanged */ }
  function selectMonth(month) { /* unchanged */ }

  // ================== Chart Initialization & Improved Circle Graph ==================
  let circleChartInstance = null;

  function initCharts() {
    // Wave Graphs (unchanged)
    // ...
    // Draw circle graph with improved label placement
    drawCircleGraph();
  }

  function drawCircleGraph() {
    const ctx = document.getElementById('circleChart').getContext('2d');
    if (circleChartInstance) circleChartInstance.destroy();

    circleChartInstance = new Chart(ctx, {
      type:'doughnut',
      data:{
        labels:['Fast Food','Asian','Pasta','Mexican','Turkish','Desserts'],
        datasets:[{
          label:'Food Types',
          data:[40,20,15,10,5,10],
          backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'],
          hoverOffset:4
        }]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{ position:'bottom' },
          tooltip:{ enabled: false }
        }
      }
    });
    // Update label position: move percentage label closer
    document.getElementById('circlePercentage').innerText='70%'; // or update dynamically
  }

  // ================== Update circle percentage dynamically ==================
  function updateCirclePercentage(percentage) {
    document.getElementById('circlePercentage').innerText=percentage+'%';
  }

  // ================== Role Popup Functions (unchanged) ==================
  function showRolePopup() { /* unchanged */ }
  function closeRolePopup() { /* unchanged */ }
  function viewRoleInfo(roleType, email) { /* unchanged */ }
  function deleteRole(roleType, email) { /* unchanged */ }
  function showRoleInfo() { /* unchanged */ }
  function closeRoleInfo() { /* unchanged */ }
  function sendNotification() { /* unchanged */ }

  // ================== Driver & Vendor Functions (unchanged) ==================
  function showVendors() { alert('Display all vendors with accept/reject options and history.'); }
  function showPastDeliveries(driverName) { alert('Showing past deliveries for ' + driverName); }
  function showDocuments(driverName) { alert('Showing documents for ' + driverName); }

  // Load driver data (simulate)
  async function loadDrivers() { /* unchanged */ }

  // Load vendor data (simulate)
  async function loadVendors() { /* unchanged */ }

  // On page load
  window.onload = () => {
    if (!isAuthenticated) {
      document.getElementById('loginModal').style.display='flex';
    } else {
      document.getElementById('loginModal').style.display='none';
    }
    initCharts();
    updateMonthlyData('January');
    loadDrivers();
    loadVendors();
  };
</script>
<!-- Import your supabase client setup (from your code) -->
<script src="supabaseClient.js" async></script>
<script src="payfast-track.js" async></script>

</body>
</html>