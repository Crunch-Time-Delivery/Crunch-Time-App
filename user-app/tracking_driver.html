<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Track Driver</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #d32f2f;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      outline: none;
    }
    input:focus {
      border-color: #d32f2f;
    }
    button {
      padding: 12px 20px;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) {
      background: #b71c1c;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #map {
      width: 100%;
      height: 300px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-top: 15px;
      background: #e8f5e9;
    }
    .status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
      display: none;
    }
    .status.connecting { background: #fff8e1; color: #ff8f00; display: block; }
    .status.tracking { background: #e8f5e9; color: #2e7d32; display: block; }
    .status.error { background: #ffebee; color: #c62828; display: block; }
  </style>
</head>
<body>

<div class="container">
  <h1>Track Your Driver</h1>
  <div class="input-group">
    <input type="text" id="orderId" placeholder="Enter Order ID (e.g. ORD123)" />
    <button id="trackBtn">Track</button>
  </div>
  <div id="map"></div>
  <div id="status" class="status">No location selected.</div>
</div>

<!-- Google Maps API - Replace YOUR_API_KEY -->
<script>
  // === CONFIG ===
  const API_URL = 'https://your-api.example.com/location'; // CHANGE THIS
  const GOOGLE_MAPS_API_KEY = 'YOUR_API_KEY'; // CHANGE THIS

  // === Global Variables ===
  let map, driverMarker, customerMarker;
  let tracking = false;
  let intervalId = null;
  let customerLat = 37.7850, customerLng = -122.4383;

  // === 1. Customer Location (Geolocation) ===
  function updateCustomerLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          customerLat = pos.coords.latitude;
          customerLng = pos.coords.longitude;
          updateCustomerMarker();
        },
        () => console.warn("Geolocation denied")
      );
    }
  }

  function currentCustomerLocation() {
    return { lat: customerLat, lng: customerLng };
  }

  // Update every 15 seconds
  setInterval(updateCustomerLocation, 15000);
  updateCustomerLocation(); // Initial

  // === 2. Google Maps Init ===
  function initMap() {
    const center = currentCustomerLocation();

    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 14,
      center: center,
      mapTypeId: 'roadmap',
      disableDefaultUI: false,
      zoomControl: true
    });

    // Customer Marker (You)
    customerMarker = new google.maps.Marker({
      map: map,
      title: "You are here",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 9,
        fillColor: '#4285f4',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 2
      }
    });

    // Driver Marker
    driverMarker = new google.maps.Marker({
      map: map,
      title: "Driver",
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 11,
        fillColor: '#d32f2f',
        fillOpacity: 1,
        strokeColor: '#fff',
        strokeWeight: 3
      }
    });

    updateCustomerMarker();
  }

  function updateCustomerMarker() {
    if (customerMarker) {
      customerMarker.setPosition(currentCustomerLocation());
      map.panTo(currentCustomerLocation());
    }
  }

  function updateDriverLocation(lat, lng) {
    const pos = { lat: parseFloat(lat), lng: parseFloat(lng) };
    driverMarker.setPosition(pos);
    map.panTo(pos);
    map.setZoom(15);
  }

  // === 3. Live Tracking Logic ===
  document.addEventListener('DOMContentLoaded', () => {
    const orderInput = document.getElementById('orderId');
    const trackBtn = document.getElementById('trackBtn');
    const statusEl = document.getElementById('status');

    const startTracking = () => {
      const orderId = orderInput.value.trim();
      if (!orderId || tracking) return;

      tracking = true;
      trackBtn.disabled = true;
      trackBtn.textContent = 'Tracking...';
      statusEl.className = 'status connecting';
      statusEl.textContent = 'Connecting to driver...';

      // Initial fetch
      pollDriverLocation(orderId);

      // Poll every 3 seconds
      intervalId = setInterval(() => pollDriverLocation(orderId), 3000);
    };

    const pollDriverLocation = async (orderId) => {
      try {
        const res = await fetch(`${API_URL}?order=${encodeURIComponent(orderId)}`, {
          cache: 'no-cache'
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();

        if (data.lat != null && data.lng != null) {
          updateDriverLocation(data.lat, data.lng);
          statusEl.className = 'status tracking';
          statusEl.textContent = 'Driver is moving...';
        } else {
          throw new Error("Invalid data");
        }
      } catch (err) {
        console.warn('Poll failed:', err);
        if (!statusEl.classList.contains('error')) {
          statusEl.className = 'status error';
          statusEl.textContent = 'Driver not found or offline.';
          stopTracking();
        }
      }
    };

    const stopTracking = () => {
      clearInterval(intervalId);
      tracking = false;
      trackBtn.disabled = false;
      trackBtn.textContent = 'Track';
    };

    trackBtn.addEventListener('click', startTracking);
    orderInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') startTracking();
    });

    window.stopTracking = stopTracking;
  });

  // === Load Google Maps ===
  (function loadGoogleMaps() {
    if (typeof google !== 'undefined') return;
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initMap`;
    script.async = true;
    script.defer = true;
    script.onerror = () => alert('Failed to load Google Maps. Check API key.');
    document.head.appendChild(script);
  })();

  src="user-app/client/public/src/functions/live-tracking.js"; // folder connection
  src="functions/mapFunctions.js"; // folder connection
  src="user-app/pinpoint.js"; // folder connection
    src="user-app/googleMapConfig.js"; // folder connection

</script>

</body>
</html>