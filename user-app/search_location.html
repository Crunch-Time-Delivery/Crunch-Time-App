<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Search Delivery Location</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #f5f5f5;
}
.search-location-container {
  max-width: 600px;
  margin: auto;
  background: #fff;
  padding: 16px;
  border-radius: 12px;
}
.title-row {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}
h1 {
  margin: 0;
  font-size: 22px;
  flex: 1;
}
.red-column {
  width: 20px;
  height: 20px;
  background: red;
  border-radius: 4px;
}
form {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}
input[type="text"] {
  flex: 1;
  padding: 10px;
  font-size: 16px;
}
button {
  padding: 10px 16px;
  font-size: 16px;
  cursor: pointer;
}
#map {
  height: 400px;
  width: 100%;
  margin-top: 15px;
  border-radius: 10px;
}
.buttons-group {
  display: flex;
  gap: 10px;
  margin-top: 12px;
  justify-content: center;
}
#coordinates {
  margin-top: 10px;
  font-size: 14px;
  text-align: center;
  font-family: monospace;
}
</style>
</head>
<body>

<div class="search-location-container">
  <div class="title-row">
    <h1>Search Delivery Location</h1>
    <div class="red-column"></div>
  </div>

  <!-- ADDRESS SEARCH -->
  <form id="locationForm">
    <input type="text" id="locationInput" placeholder="Enter address or city" required>
    <!-- Hidden input to store location data -->
    <input type="hidden" id="user_location_id" name="user_location_id" />
    <button type="submit" id="setLocationBtn">Set Location</button>
  </form>

  <!-- ACTION BUTTONS (only Use My Location and Reset) -->
  <div class="buttons-group">
    <button type="button" id="locateBtn">Use My Location</button>
    <button type="button" id="resetBtn">Reset Map</button>
  </div>

  <!-- MAP -->
  <div id="map"></div>
  <div id="coordinates">No location selected.</div>
</div>

<!-- Google Maps API with callback -->
<script
  async
  defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB9sNhi824hNncjfW7HHzaI_s8JtWGfM0Q&callback=initMap"
></script>

<script>
let map, marker, geocoder;
const DEFAULT_POS = { lat: -33.9249, lng: 18.4241 }; // Cape Town

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: DEFAULT_POS,
    zoom: 13
  });
  marker = new google.maps.Marker({
    map: map,
    position: DEFAULT_POS,
    draggable: true
  });
  geocoder = new google.maps.Geocoder();

  loadSavedLocation();

  // Search form submit
  document.getElementById("locationForm").addEventListener("submit", e => {
    e.preventDefault();
    const address = document.getElementById("locationInput").value.trim();
    if (!address) return;
    geocoder.geocode({ address }, (results, status) => {
      if (status !== "OK" || !results[0]) {
        alert("Location not found.");
        return;
      }
      const result = results[0];
      const pos = {
        lat: result.geometry.location.lat(),
        lng: result.geometry.location.lng()
      };
      saveLocation(pos, result.formatted_address);
      updateMap(pos, result.formatted_address);
      // Save location data to hidden input
      document.getElementById("user_location_id").value = pos.lat + "," + pos.lng;
      alert("Location set and saved!");
    });
  });

  // Use current location
  document.getElementById("locateBtn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("Geolocation not supported");
      return;
    }
    navigator.geolocation.getCurrentPosition(position => {
      const pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      geocoder.geocode({ location: pos }, (results, status) => {
        const address =
          status === "OK" && results[0]
            ? results[0].formatted_address
            : "My Location";
        saveLocation(pos, address);
        updateMap(pos, address);
        // Save to hidden input
        document.getElementById("user_location_id").value = pos.lat + "," + pos.lng;
      });
    }, () => alert("Permission denied or error"));
  });

  // Reset map
  document.getElementById("resetBtn").addEventListener("click", () => {
    localStorage.removeItem("deliveryCoords");
    localStorage.removeItem("deliveryAddress");
    updateMap(DEFAULT_POS, "");
    document.getElementById("locationInput").value = "";
    document.getElementById("coordinates").innerText = "No location selected.";
    // Clear hidden input
    document.getElementById("user_location_id").value = "";
  });
}

function updateMap(pos, address) {
  map.setCenter(pos);
  map.setZoom(15);
  marker.setPosition(pos);
  document.getElementById("coordinates").innerText =
    `Lat: ${pos.lat.toFixed(5)}, Lng: ${pos.lng.toFixed(5)}`;
  if (address) document.getElementById("locationInput").value = address;
}

function saveLocation(pos, address) {
  localStorage.setItem("deliveryCoords", JSON.stringify(pos));
  localStorage.setItem("deliveryAddress", address);
}

function loadSavedLocation() {
  const coordsStr = localStorage.getItem("deliveryCoords");
  const address = localStorage.getItem("deliveryAddress");
  if (coordsStr && address) {
    updateMap(JSON.parse(coordsStr), address);
  }
}
</script>
</body>
</html>